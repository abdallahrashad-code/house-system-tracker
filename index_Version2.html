<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>House System Tracker — Professional Dashboard</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN quick) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

  <!-- Recharts -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.2/dist/Recharts.min.js"></script>

  <style>
    :root{
      --bg: #0f172a; /* dark slate */
      --panel: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.03);
      --muted: #94a3b8;
      --accent: linear-gradient(90deg,#00d4ff 0%,#7c3aed 100%);
      --radius: 12px;
      --glass-border: rgba(255,255,255,0.04);
    }
    [data-theme="light"]{
      --bg: #f8fafc;
      --panel: rgba(255,255,255,0.75);
      --glass: rgba(255,255,255,0.85);
      --muted: #64748b;
      --glass-border: rgba(15,23,42,0.06);
    }

    html,body{height:100%;}
    body{
      margin:0;
      min-height:100vh;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 500px at 10% 10%, rgba(124,58,237,0.06), transparent 10%),
                  radial-gradient(900px 400px at 90% 90%, rgba(0,212,255,0.04), transparent 10%),
                  var(--bg);
      color: var(--muted);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:18px 22px;
      border-bottom:1px solid var(--glass-border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      backdrop-filter: blur(6px);
    }
    .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .brand .logo {
      width:44px;height:44px;border-radius:10px;
      background: linear-gradient(135deg,#7c3aed,#00d4ff);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:800;
      box-shadow: 0 6px 30px rgba(12,12,20,0.25);
      font-family: "JetBrains Mono", monospace;
    }
    .glass-card{
      background: var(--glass);
      border-radius: var(--radius);
      border: 1px solid var(--glass-border);
      padding:16px;
      box-shadow:0 8px 30px rgba(2,6,23,0.35);
    }
    .glassy-btn {
      background: var(--accent);
      color:white; padding:8px 14px; border-radius:999px; font-weight:700;
      box-shadow: 0 6px 20px rgba(12,12,40,0.18);
    }
    .muted { color: var(--muted); }
    .small { font-size:12px; }
    .card-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:18px; }
    .col-span-4 { grid-column: span 4 / span 4; }
    .col-span-8 { grid-column: span 8 / span 8; }
    @media (max-width: 900px) {
      .card-grid { grid-template-columns: repeat(1, 1fr); }
      .col-span-4, .col-span-8 { grid-column: auto; }
    }

    /* tiny tweaks for tables / lists */
    .compact-table th, .compact-table td { padding:8px 10px; font-size:13px; color:inherit; }
    .sparkline { height:36px; width:120px; display:block; }
    .legend-dot { width:10px;height:10px;border-radius:2px;margin-right:8px; display:inline-block; }
    /* subtle animations */
    .fade-in { animation: fadeIn .4s ease both; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform:none} }
  </style>
</head>
<body>
  <div id="root"></div>

<script type="module">
/* eslint-disable no-unused-vars */
/* Modernized UI + professional charts (Recharts) — integrated into existing app logic */

import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import {
  getAuth, signInAnonymously, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import {
  getFirestore, collection, doc, setDoc, getDocs, onSnapshot, query, orderBy, limit, writeBatch, runTransaction, increment, deleteDoc
} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyC1rWI1b87xeqHJtYmsRUL8Ruf33nJiQIM",
  authDomain: "house-system-f54a3.firebaseapp.com",
  projectId: "house-system-f54a3",
  storageBucket: "house-system-f54a3.appspot.com",
  messagingSenderId: "171645573652",
  appId: "1:171645573652:web:9942711f898071a66ba501"
};

const appId = 'house-system-v1';
const { useState, useEffect, useMemo } = React;
const e = React.createElement;
const RC = window.Recharts || {};

// --- seed data (unchanged) ---
const INITIAL_USERS = [
  { email: "teacher@school.edu", password: "password123", role: "staff", name: "Default Teacher" },
  { email: "admin@school.edu", password: "admin123", role: "admin", name: "System Admin" }
];
const HOUSE_SEED_DATA = [
  { name: 'Rihno', color: '#10b981', motto: "Strength in Unity" },
  { name: 'Cougar', color: '#3b82f6', motto: "Courage and Grace" },
  { name: 'Eagles', color: '#f59e0b', motto: "Soaring to Success" },
  { name: 'Oraca', color: '#ef4444', motto: "Passion and Precision" }
];
const RUBRIC_SEED_DATA = [
  { category: 'Academic', action: 'High test scores', points: 15, is_miss_out: false },
  { category: 'Behavior', action: 'Compassion: Act of kindness', points: 30, is_miss_out: false },
  { category: 'Behavior', action: 'Respect: Show respect & Good Manners', points: 30, is_miss_out: false },
  { category: 'Events', action: 'Winning a school competition', points: 20, is_miss_out: false },
  { category: 'Miss-Out', action: 'Misbehavior in events', points: -10, is_miss_out: true }
];
const FULL_STUDENT_DATA = [
  {"name":"Yaseen Aseem Saady","class_name":"Grade 10","house_id":"Eagles"},
  {"name":"Abdelrahman Bahaa","class_name":"Grade 10","house_id":"Cougar"},
  {"name":"Karma Mahmoud","class_name":"Grade 9","house_id":"Eagles"},
  {"name":"Reem Hossam","class_name":"Grade 9","house_id":"Oraca"},
  {"name":"Retal Mohamed","class_name":"Grade 8","house_id":"Rihno"},
  {"name":"Adam Ahmed","class_name":"Grade 8","house_id":"Cougar"},
  {"name":"Laila Mahmoud","class_name":"Grade 7","house_id":"Cougar"},
  {"name":"Lamis Ahmed","class_name":"Grade 7","house_id":"Rihno"},
  {"name":"Sara Mohamed","class_name":"Grade 6","house_id":"Rihno"},
  {"name":"Saeed Ahmed","class_name":"Grade 6","house_id":"Cougar"},
  {"name":"Adham Yousry","class_name":"Grade 5","house_id":"Oraca"},
  {"name":"Selim Mohamed","class_name":"Grade 5","house_id":"Oraca"},
  {"name":"Aseel Atef","class_name":"Grade 4","house_id":"Cougar"},
  {"name":"Layan Mohamed","class_name":"Grade 4","house_id":"Cougar"},
  {"name":"Yousef Mohamed","class_name":"Grade 3","house_id":"Cougar"},
  {"name":"Elaf Mohamed","class_name":"Grade 3","house_id":"Eagles"},
  {"name":"Anas Ahmed","class_name":"Y2-B","house_id":"Rihno"},
  {"name":"YOUSSEF MOHAMED","class_name":"Y2-C","house_id":"Eagles"},
  {"name":"Mourad Mohamed","class_name":"Y2-A","house_id":"Cougar"},
  {"name":"Laila Amr","class_name":"Y1-E","house_id":"Oraca"},
  {"name":"Asma Osman","class_name":"Y1-D","house_id":"Rihno"},
  {"name":"Adam Mohammed","class_name":"Y1-C","house_id":"Eagles"},
  {"name":"Ismail Muhammad","class_name":"Y1-B","house_id":"Cougar"},
  {"name":"Raheem Yasser","class_name":"Y1-A","house_id":"Oraca"},
  {"name":"Zain Ahmed","class_name":"Pre.K","house_id":"Eagles"},
  {"name":"Gamila Ramy","class_name":"Pre.K","house_id":"Oraca"},
  {"name":"Hamza Zayed","class_name":"Pre.K","house_id":"Rihno"},
  {"name":"Farah Husam","class_name":"Pre.K","house_id":"Eagles"}
];
const CLASS_NAMES = [...new Set(FULL_STUDENT_DATA.map(s => s.class_name))].sort();

// --- simple icons ---
const Icons = {
  Star: () => e('svg', { xmlns: "http://www.w3.org/2000/svg", width:18, height:18, fill:"none", stroke:"#fbbf24", strokeWidth:2, strokeLinecap:"round", strokeLinejoin:"round" },
    e('polygon',{points:"9 1.5 11.27 6.54 16 6.99 12.5 10.36 13.5 15.9 9 13.1 4.5 15.9 5.5 10.36 2 6.99 6.73 6.54 9 1.5"})),
  Spark: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",stroke:"currentColor",strokeWidth:1.5},e('path',{d:"M8 3v10M3 8h10"}))
};

/* ---------------------------
   Enhanced charts & dashboard
   --------------------------- */
const HouseAnalytics = ({ houses = [], transactions = [] }) => {
  // Pie / Distribution
  const housePie = (houses || []).map(h => ({ name: h.name, value: h.total_points || 0, color: (HOUSE_SEED_DATA.find(x=>x.name===h.name)?.color||'#777') }));

  // Time-series: group transactions by day (UTC)
  const tsMap = {};
  (transactions || []).slice().reverse().forEach(t => {
    // expected timestamp ISO string
    const d = t.timestamp ? new Date(t.timestamp) : null;
    const day = d ? d.toISOString().slice(0,10) : 'unknown';
    tsMap[day] = (tsMap[day] || 0) + (Number(t.points) || 0);
  });
  const tsArr = Object.keys(tsMap).sort().map(k => ({ date: k, points: tsMap[k] }));

  // If no transactions, generate light demo smoothing by houses totals
  const barData = (houses || []).map(h => ({ name: h.name, points: h.total_points || 0, color: HOUSE_SEED_DATA.find(x=>x.name===h.name)?.color || '#888' }));

  // small sparklines per house (generate mini series from transactions filtered by houseId)
  const houseSparks = (houses || []).map(h => {
    const houseTx = (transactions || []).filter(t => String(t.houseId) === String(h.name));
    // build per-day series for last 7 days
    const now = new Date();
    const days = [];
    for(let i=6;i>=0;i--){
      const d = new Date(now); d.setDate(now.getDate()-i);
      const k = d.toISOString().slice(0,10);
      const val = houseTx.filter(t => (t.timestamp||'').slice(0,10) === k).reduce((s,x)=>s+(Number(x.points)||0),0);
      days.push({ date: k, value: val });
    }
    return { house: h.name, color: HOUSE_SEED_DATA.find(x=>x.name===h.name)?.color||'#888', series: days };
  });

  // Render with Recharts, fallback text if missing
  if (!RC || !RC.ResponsiveContainer) {
    return e('div', { className: "glass-card" },
      e('div', null, "Charts unavailable (Recharts failed to load)")
    );
  }

  return e('div', { className: "card-grid fade-in", style: { marginTop: 8 } },
    // Left: bar + pie stacked
    e('div', { className: "glass-card col-span-8" },
      e('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 } },
        e('div', null, e('div', { style: { fontWeight: 700, fontSize: 16, color: 'inherit' } }, 'House Points Overview'),
          e('div', { className: 'small muted' }, 'Live totals & recent activity summary')
        ),
        e('div', null, e('span', { className: 'small muted' }, `Houses: ${houses.length || 0}`))
      ),
      e(RC.ResponsiveContainer, { width: "100%", height: 260 },
        e(RC.ComposedChart, { data: barData, margin: { top: 10, right: 30, left: 0, bottom: 0 } },
          e(RC.CartesianGrid, { strokeDasharray: "3 3", opacity: 0.06 }),
          e(RC.XAxis, { dataKey: "name", tickLine: false, axisLine: false }),
          e(RC.YAxis, { tickLine:false, axisLine:false }),
          e(RC.Tooltip, null),
          e(RC.Bar, { dataKey: "points", barSize: 36, radius: [6,6,6,6] },
            barData.map((entry, i) => e(RC.Cell, { key: `b-${i}`, fill: entry.color }))
          ),
          e(RC.Line, { type: "monotone", dataKey: "points", stroke: "#ffffff", strokeOpacity: 0.08 })
        )
      )
    ),
    // Right column: pie + small details
    e('div', { className: "glass-card col-span-4" },
      e('div', { style: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: 8 } },
        e('div', null, e('div', { style: { fontWeight:700, fontSize:15 } }, "Distribution")),
        e('div', { className: "small muted" }, "By house")
      ),
      e(RC.ResponsiveContainer, { width: "100%", height: 180 },
        e(RC.PieChart, null,
          e(RC.Pie, { data: housePie, dataKey: "value", nameKey: "name", cx: "50%", cy: "50%", outerRadius: 60, labelLine: false, label: ({name})=>name },
            housePie.map((entry,i)=> e(RC.Cell, { key:`p-${i}`, fill: entry.color }))
          ),
          e(RC.Tooltip), e(RC.Legend, { layout: "vertical", verticalAlign: "middle", align: "right", wrapperStyle: { right: 12, top: 12, fontSize: 12 } })
        )
      ),
      e('div', { style: { marginTop: 10 } },
        e('div', { className: "small muted" }, "Recent trend (transactions aggregated by day)"),
        e(RC.ResponsiveContainer, { width: "100%", height: 80 },
          e(RC.AreaChart, { data: tsArr },
            e(RCdefs(), null),
            e(RC.XAxis, { dataKey: "date", hide: true }),
            e(RC.YAxis, { hide: true }),
            e(RC.Area, { type: "monotone", dataKey: "points", stroke: "#7c3aed", fill: "#7c3aed", fillOpacity: 0.08 })
          )
        )
      )
    ),

    // Sparklines row (one small card per house)
    houseSparks.map((h,i) =>
      e('div', { key:`spark-${i}`, className: "glass-card", style: { alignSelf: 'center' } },
        e('div', { style: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:6 } },
          e('div', null, e('div', { style: { fontWeight:700 } }, h.house), e('div', { className:'small muted' }, HOUSE_SEED_DATA.find(x=>x.name===h.house)?.motto || '')),
          e('div', null, e('span', { className:'legend-dot', style: { background: h.color } }))
        ),
        e(RC.ResponsiveContainer, { width: '100%', height: 48 },
          e(RC.LineChart, { data: h.series },
            e(RC.Line, { type:'monotone', dataKey:'value', stroke: h.color, strokeWidth:2, dot:false }),
            e(RC.Tooltip, { labelFormatter: v=>v })
          )
        )
      )
    )
  );
};

/* small helper to prevent direct RC defs undefined error in some bundlings */
function RCdefs(){ return e('defs', null); }

/* ---------------------------
   Rest of app (keeps existing structure)
   I changed HouseLeaderboard -> HouseAnalytics (uses houses + transactions)
   and passed transactions forward from App when rendering analytics
   --------------------------- */

/* Use previously defined components: Login, EntryView, AdminView etc.
   For brevity we will reuse the project's earlier components with minimal edits:
   - Important: when rendering the main dashboard, pass transactions into analytics */

const Login = ({ db, appId, setIsStaff, setUserName, setIsAdmin, setActiveView }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [err, setErr] = useState('');
  const doLogin = async (ev) => {
    ev.preventDefault();
    try {
      const q = query(collection(db, `/artifacts/${appId}/public/data/users`));
      const snap = await getDocs(q);
      const found = snap.docs.map(d=>d.data()).find(u => u.email === email && u.password === password);
      if (found) {
        setIsStaff(true);
        setUserName(found.name || email);
        setIsAdmin(found.role === 'admin');
        setActiveView(found.role === 'admin' ? 'admin' : 'entry');
      } else {
        setErr("Invalid credentials");
      }
    } catch (err) {
      console.error(err);
      setErr("Login error");
    }
  };

  const signInWithGoogle = async () => {
    setErr('');
    try {
      const auth = getAuth();
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userEmail = user.email;
      const usersCol = collection(db, `/artifacts/${appId}/public/data/users`);
      const snap = await getDocs(usersCol);
      const found = snap.docs.map(d=>d.data()).find(u => u.email === userEmail);
      if (found) {
        setIsStaff(found.role === 'staff' || found.role === 'admin');
        setIsAdmin(found.role === 'admin');
        setUserName(found.name || user.displayName || userEmail);
        setActiveView(found.role === 'admin' ? 'admin' : 'entry');
      } else {
        setErr("User not authorized. Please contact admin.");
        await signOut(getAuth());
      }
    } catch (error) {
      console.error('Google sign-in failed:', error);
      setErr("Google sign-in failed: " + (error.message || error));
    }
  };

  return e('div', { className: "flex items-center justify-center min-h-screen" },
    e('form', { onSubmit: doLogin, className: "glass-card w-96 space-y-4" },
      e('h2', { className: "text-2xl font-bold" }, "Staff Login"),
      err && e('div', { className: "text-red-400 small" }, err),
      e('input', { className: "w-full border p-2 rounded", placeholder: "Email", value: email, onChange: e=>setEmail(e.target.value) }),
      e('input', { className: "w-full border p-2 rounded", type:"password", placeholder: "Password", value: password, onChange: e=>setPassword(e.target.value) }),
      e('button', { className: "glassy-btn w-full" }, "Login"),
      e('div', { className: "text-center text-sm text-gray-400 py-2" }, "Or"),
      e('button', { type: 'button', onClick: signInWithGoogle, className: "w-full border py-2 rounded flex items-center justify-center gap-2 bg-white" },
        e('img', { src: 'https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg', alt: 'Google', className: 'w-5 h-5' }),
        e('span', null, 'Sign in with Google')
      ),
      e('div', { className: "text-xs text-gray-400 text-center" }, "Try: teacher@school.edu / password123")
    )
  );
};

/* For brevity reusing simple EntryView & AdminView earlier — they work with the same data shape.
   If you want I can also upgrade AdminView visuals in the next iteration. */

const EntryView = ({ allStudents, rubric, db, appId, userName }) => {
  const [selectedClass, setSelectedClass] = useState(CLASS_NAMES[0]);
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [studentSearch, setStudentSearch] = useState('');
  const [statusMessage, setStatusMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const filtered = useMemo(() => {
    let list = (allStudents || []).filter(s => s.class_name === selectedClass).sort((a,b)=>a.name.localeCompare(b.name));
    if (studentSearch) list = list.filter(s => s.name.toLowerCase().includes(studentSearch.toLowerCase()));
    return list;
  }, [allStudents, selectedClass, studentSearch]);

  const handleAward = async (item) => {
    if (!selectedStudent) return;
    setIsLoading(true);
    try {
      const basePath = `/artifacts/${appId}/public/data`;
      const firestore = getFirestore();
      await runTransaction(firestore, async (t) => {
        const sRef = doc(firestore, `${basePath}/students`, selectedStudent.id);
        const hRef = doc(firestore, `${basePath}/houses`, selectedStudent.house_id);
        const sDoc = await t.get(sRef);
        const hDoc = await t.get(hRef);
        if (!sDoc.exists() || !hDoc.exists()) throw new Error('Missing student or house');
        t.update(sRef, { current_points: increment(item.points) });
        t.update(hRef, { total_points: increment(item.points) });
        t.set(doc(collection(firestore, `${basePath}/transactions`)), {
          action: item.action,
          points: item.points,
          timestamp: new Date().toISOString(),
          awardedBy: userName,
          studentName: selectedStudent.name,
          houseId: selectedStudent.house_id,
          category: item.category
        });
      });
      setStatusMessage(`✅ ${item.points>0?'+':''}${item.points} points to ${selectedStudent.name}`);
      setTimeout(()=>setStatusMessage(''), 3000);
    } catch (err) {
      console.error(err);
      setStatusMessage('❌ Error awarding points');
    }
    setIsLoading(false);
    setSelectedStudent(null);
  };

  return e('div', { className: "p-6 max-w-6xl mx-auto" },
    e('div', { style: { display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12 } },
      e('h2', { style: { fontWeight:700, fontSize:20 } }, "Point Entry"),
      e('span', { className: "small muted" }, userName || 'Staff')
    ),
    statusMessage && e('div', { className: "glass-card small" }, statusMessage),
    e('div', { className: "card-grid", style: { marginTop: 16 } },
      e('div', { className: "glass-card col-span-4" },
        e('label', { className: "small muted" }, "Class"),
        e('select', { className: "w-full border p-2 rounded mb-3", value: selectedClass, onChange: e=>{ setSelectedClass(e.target.value); setSelectedStudent(null); } },
          CLASS_NAMES.map(c => e('option', { key: c, value: c }, c))
        ),
        e('input', { className: "w-full border p-2 rounded mb-3", placeholder: "Search student...", value: studentSearch, onChange: e=>setStudentSearch(e.target.value) }),
        e('div', { style: { maxHeight: 360, overflowY: 'auto' } },
          filtered.map(s => e('div', {
            key: s.id, onClick: ()=>setSelectedStudent(s),
            style: { padding:12, borderRadius:8, border:'1px solid var(--glass-border)', marginBottom:8, cursor:'pointer', display:'flex', justifyContent:'space-between', alignItems:'center', background: selectedStudent?.id===s.id ? 'linear-gradient(90deg,#7c3aed22,#00d4ff11)' : 'transparent' }
          }, e('div', null, e('div', { style:{ fontWeight:700, color:'inherit' } }, s.name), e('div', { className: 'small muted' }, s.house_id)), e('div', { style:{ fontWeight:700 } }, s.current_points || 0)))
        )
      ),
      e('div', { className: "glass-card col-span-8" },
        e('div', { style: { marginBottom:12 } }, e('h3', { style: { fontWeight:700 } }, "Award & Deduct")),
        e('div', { style: { display:'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px,1fr))', gap:12 } },
          RUBRIC_SEED_DATA.map(r => e('button', {
            key: r.action, onClick: ()=>handleAward(r), disabled: !selectedStudent || isLoading,
            style: { padding:12, borderRadius:10, border:'1px solid var(--glass-border)', textAlign:'left', background: r.is_miss_out ? 'rgba(255, 90, 90, 0.04)' : 'rgba(30,200,150,0.03)', cursor: (!selectedStudent||isLoading) ? 'not-allowed' : 'pointer' }
          }, e('div', { style:{ display:'flex', justifyContent:'space-between', alignItems:'center' } }, e('div', { style:{ fontWeight:700, fontSize:18, color: r.is_miss_out ? '#ef4444' : '#059669' } }, r.is_miss_out ? r.points : `+${r.points}`), e('div', { className:'small muted' }, r.category)), e('div', { style:{ marginTop:6, fontWeight:700 } }, r.action)))
        )
      )
    )
  );
};

const AdminView = ({ db, appId, transactions, usersList, houses }) => {
  // For now reuse previous AdminView but with visual polish is already handled in CSS
  return e('div', { className: "p-6 max-w-6xl mx-auto" },
    e('div', { style:{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:12 } },
      e('h2', { style:{ fontWeight:800, fontSize:20 } }, 'Admin Dashboard'),
      e('div', null)
    ),
    e('div', { className:'card-grid' },
      e('div', { className:'glass-card col-span-4' },
        e('h3', null, 'Users'),
        e('div', { style:{ maxHeight:300, overflowY:'auto' } },
          (usersList||[]).map(u => e('div', { key:u.id, style:{ display:'flex', justifyContent:'space-between', padding:8, borderBottom:'1px solid var(--glass-border)' } }, e('div', null, e('div',{style:{fontWeight:700}},u.name), e('div',{className:'small muted'},u.email)), e('div', null, e('div',{className:'small muted'},u.role))))
        )
      ),
      e('div', { className:'glass-card col-span-8' },
        e('h3', null, 'Recent Activity'),
        e('div', { style:{ maxHeight:300, overflowY:'auto' } },
          (transactions||[]).slice(0,50).map(t => e('div', { key:t.id, style:{ display:'flex', justifyContent:'space-between', padding:8, borderBottom:'1px solid var(--glass-border)' } }, e('div', null, e('div',{style:{fontWeight:700}}, t.studentName || '—'), e('div',{className:'small muted'}, (t.action||'') + (t.category ? ` • ${t.category}` : ''))), e('div', { style:{ fontWeight:700, color: t.points>0 ? '#10b981' : '#ef4444' } }, (t.points>0?'+':'') + t.points))))
        )
      )
    )
  );
};

/* ------------ Main App ------------ */
const App = () => {
  const [db, setDb] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [userId, setUserId] = useState(null);
  const [permissionError, setPermissionError] = useState(false);
  const [isStaff, setIsStaff] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);
  const [activeView, setActiveView] = useState('leaderboard');
  const [userName, setUserName] = useState('');
  const [houses, setHouses] = useState([]);
  const [rubric, setRubric] = useState([]);
  const [allStudents, setAllStudents] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [usersList, setUsersList] = useState([]);
  const [theme, setTheme] = useState('light');

  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
  }, [theme]);

  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const fAuth = getAuth(app);
    const firestore = getFirestore(app);
    setDb(firestore);

    const init = async () => {
      try {
        if (fAuth.currentUser) await signOut(fAuth);
        await signInAnonymously(fAuth);
      } catch(e) { console.error(e); }
    };
    init();

    onAuthStateChanged(fAuth, (user) => {
      if (user) { setUserId(user.uid); setIsAuthReady(true); } else setIsAuthReady(true);
    });
  }, []);

  useEffect(() => {
    if (!db || !userId || permissionError) return;
    const basePath = `/artifacts/${appId}/public/data`;
    const handleSnapshotError = (err) => { if (err?.code === 'permission-denied') setPermissionError(true); };

    (async () => {
      try {
        const housesSnap = await getDocs(collection(db, `${basePath}/houses`));
        if (housesSnap.empty) {
          const batch = writeBatch(db);
          HOUSE_SEED_DATA.forEach(h => batch.set(doc(db, `${basePath}/houses`, h.name), { ...h, total_points: 0 }));
          RUBRIC_SEED_DATA.forEach(r => batch.set(doc(db, `${basePath}/rubric`, r.action.replace(/[^a-zA-Z0-9]/g, '_')), r));
          INITIAL_USERS.forEach(u => batch.set(doc(db, `${basePath}/users`, u.email.replace(/[^a-zA-Z0-9]/g, '_')), u));
          FULL_STUDENT_DATA.forEach(s => {
            const safeId = `${s.name.replace(/[^a-zA-Z0-9]/g, '')}_${s.class_name.replace(/[^a-zA-Z0-9]/g, '')}`;
            batch.set(doc(db, `${basePath}/students`, safeId), { ...s, current_points: 0, id: safeId });
          });
          await batch.commit();
        }
      } catch (err) {
        if (err?.code === 'permission-denied') setPermissionError(true);
        console.error('Seeding error', err);
      }
    })();

    const unsubH = onSnapshot(collection(db, `${basePath}/houses`), s => setHouses(s.docs.map(d=>({ id:d.id, ...d.data() }))), handleSnapshotError);
    const unsubR = onSnapshot(collection(db, `${basePath}/rubric`), s => setRubric(s.docs.map(d=>({ id:d.id,...d.data() }))), handleSnapshotError);
    const unsubS = onSnapshot(collection(db, `${basePath}/students`), s => setAllStudents(s.docs.map(d=>({ id:d.id,...d.data() }))), handleSnapshotError);
    const unsubT = onSnapshot(query(collection(db, `${basePath}/transactions`), orderBy('timestamp','desc'), limit(200)), s => setTransactions(s.docs.map(d=>({ id:d.id,...d.data() }))), handleSnapshotError);

    let unsubU = () => {};
    if (isAdmin) unsubU = onSnapshot(collection(db, `${basePath}/users`), s => setUsersList(s.docs.map(d=>({ id:d.id,...d.data() }))), handleSnapshotError);

    return () => { unsubH();unsubR();unsubS();unsubT();unsubU(); };
  }, [db, userId, isAdmin, permissionError]);

  const handleLogout = () => { setIsStaff(false); setIsAdmin(false); setUserName(''); setActiveView('leaderboard'); };

  if (permissionError) {
    return e('div', { style: { display:'flex', alignItems:'center', justifyContent:'center', minHeight:'100vh', padding:20 } },
      e('div', { className: 'glass-card', style:{ maxWidth:640, textAlign:'center' } },
        e('div', null, e('svg',{width:48,height:48,viewBox:'0 0 24 24',fill:'none',stroke:'#ef4444',strokeWidth:1.6}, e('path',{d:'M12 17v-6'}), e('path',{d:'M8 10h8'}))),
        e('h2', { style:{ fontWeight:700,fontSize:20, marginTop:12 } }, 'Permission Denied'),
        e('p', { className:'small muted' }, 'Your Firestore Rules are blocking access. For testing only, you can set rules to open.'),
        e('pre', { className:'small', style:{ marginTop:12, textAlign:'left', background:'#071126', color:'#fff', padding:12, borderRadius:8 } }, "rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}")
      )
    );
  }

  if (!isAuthReady) return e('div', { style:{ display:'flex', alignItems:'center', justifyContent:'center', minHeight:'100vh' } }, "Loading...");

  return e('div', null,
    // topbar
    e('div', { className: 'topbar' },
      e('div', { className: 'brand' },
        e('div', { className: 'logo' }, 'HS'),
        e('div', null, e('div', { style:{ fontWeight:800, color:'inherit' } }, 'House System Tracker'), e('div', { className:'small muted' }, 'Professional Dashboard'))
      ),
      e('div', { style:{ display:'flex', alignItems:'center', gap:10 } },
        e('button', { className:'glassy-btn', onClick: ()=>setActiveView('leaderboard') }, 'Dashboard'),
        e('button', { className:'glassy-btn', onClick: ()=>setActiveView('entry') }, 'Entry'),
        isAdmin && e('button', { className:'glassy-btn', onClick: ()=>setActiveView('admin') }, 'Admin'),
        isStaff && e('button', { onClick: handleLogout, style:{ padding:'8px 12px', borderRadius:10, border:'1px solid var(--glass-border)' } }, 'Logout'),
        e('button', { onClick: ()=>setTheme(t => t==='light'?'dark':'light'), title:'Toggle theme', style:{ padding:8, borderRadius:8, border:'1px solid var(--glass-border)' } }, e(Icons.Spark))
      )
    ),

    e('main', { style:{ padding:20 } },
      activeView === 'leaderboard' && e(HouseAnalytics, { houses, transactions }),
      activeView === 'entry' && (isStaff ? e(EntryView, { allStudents, rubric, db, appId, userName }) : e(Login, { db, appId, setIsStaff, setUserName, setIsAdmin, setActiveView })),
      activeView === 'admin' && e(AdminView, { db, appId, transactions, usersList, houses })
    )
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(e(App));
</script>

</body>
</html>