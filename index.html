<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>House System Tracker — Classroom Integrated</title>

  <!-- Tailwind (CDN for quick deploy; replace with built Tailwind for production) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

  <!-- Recharts for charts -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.2/dist/Recharts.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(115deg,#f3f4f6 0,#ffffff 74%); margin:0; min-height:100vh; }
    .glass { background: rgba(255,255,255,0.85); backdrop-filter: blur(8px); border-radius: 12px; border: 1px solid rgba(200,200,200,0.3); }
    .glassy-btn { background: linear-gradient(90deg,#6366f1,#14b8a6); color:white; padding:0.5rem 1rem; border-radius:9999px; font-weight:600; }
    .card-anim { transition: transform .18s, box-shadow .18s; }
    .card-anim:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(16,24,40,0.08); }
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:50; }
    .modal { width: min(940px,95%); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    // Firebase (modular)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import {
      getAuth,
      signInAnonymously,
      signInWithPopup,
      signOut,
      GoogleAuthProvider,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDocs,
      onSnapshot,
      query,
      orderBy,
      limit,
      writeBatch,
      runTransaction,
      increment,
      deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // --- Project config (already set to your project) ---
    const firebaseConfig = {
      apiKey: "AIzaSyC1rWI1b87xeqHJtYmsRUL8Ruf33nJiQIM",
      authDomain: "house-system-f54a3.firebaseapp.com",
      projectId: "house-system-f54a3",
      storageBucket: "house-system-f54a3.appspot.com",
      messagingSenderId: "171645573652",
      appId: "1:171645573652:web:9942711f898071a66ba501"
    };

    // App constants
    const appId = 'house-system-v1';

    // React convenience
    const { useState, useEffect, useMemo } = React;
    const e = React.createElement;

    // --- Seed data (used if Firestore is empty) ---
    const INITIAL_USERS = [
      { email: "teacher@school.edu", password: "password123", role: "staff", name: "Default Teacher" },
      { email: "admin@school.edu", password: "admin123", role: "admin", name: "System Admin" }
    ];
    const HOUSE_SEED_DATA = [
      { name: 'Rihno', color: '#10b981', motto: "Strength in Unity" },
      { name: 'Cougar', color: '#3b82f6', motto: "Courage and Grace" },
      { name: 'Eagles', color: '#f59e0b', motto: "Soaring to Success" },
      { name: 'Oraca', color: '#ef4444', motto: "Passion and Precision" }
    ];
    const RUBRIC_SEED_DATA = [
      { category: 'Academic', action: 'High test scores', points: 15, is_miss_out: false },
      { category: 'Behavior', action: 'Compassion: Act of kindness', points: 30, is_miss_out: false },
      { category: 'Behavior', action: 'Respect: Show respect & Good Manners', points: 30, is_miss_out: false },
      { category: 'Events', action: 'Winning a school competition', points: 20, is_miss_out: false },
      { category: 'Miss-Out', action: 'Misbehavior in events', points: -10, is_miss_out: true }
    ];
    const FULL_STUDENT_DATA = [
      {"name":"Yaseen Aseem Saady","class_name":"Grade 10","house_id":"Eagles"},
      {"name":"Abdelrahman Bahaa","class_name":"Grade 10","house_id":"Cougar"},
      {"name":"Karma Mahmoud","class_name":"Grade 9","house_id":"Eagles"},
      {"name":"Reem Hossam","class_name":"Grade 9","house_id":"Oraca"},
      {"name":"Retal Mohamed","class_name":"Grade 8","house_id":"Rihno"},
      {"name":"Adam Ahmed","class_name":"Grade 8","house_id":"Cougar"},
      {"name":"Laila Mahmoud","class_name":"Grade 7","house_id":"Cougar"},
      {"name":"Lamis Ahmed","class_name":"Grade 7","house_id":"Rihno"},
      {"name":"Sara Mohamed","class_name":"Grade 6","house_id":"Rihno"},
      {"name":"Saeed Ahmed","class_name":"Grade 6","house_id":"Cougar"},
      {"name":"Adham Yousry","class_name":"Grade 5","house_id":"Oraca"},
      {"name":"Selim Mohamed","class_name":"Grade 5","house_id":"Oraca"},
      {"name":"Aseel Atef","class_name":"Grade 4","house_id":"Cougar"},
      {"name":"Layan Mohamed","class_name":"Grade 4","house_id":"Cougar"},
      {"name":"Yousef Mohamed","class_name":"Grade 3","house_id":"Cougar"},
      {"name":"Elaf Mohamed","class_name":"Grade 3","house_id":"Eagles"},
      {"name":"Anas Ahmed","class_name":"Y2-B","house_id":"Rihno"},
      {"name":"YOUSSEF MOHAMED","class_name":"Y2-C","house_id":"Eagles"},
      {"name":"Mourad Mohamed","class_name":"Y2-A","house_id":"Cougar"},
      {"name":"Laila Amr","class_name":"Y1-E","house_id":"Oraca"},
      {"name":"Asma Osman","class_name":"Y1-D","house_id":"Rihno"},
      {"name":"Adam Mohammed","class_name":"Y1-C","house_id":"Eagles"},
      {"name":"Ismail Muhammad","class_name":"Y1-B","house_id":"Cougar"},
      {"name":"Raheem Yasser","class_name":"Y1-A","house_id":"Oraca"},
      {"name":"Zain Ahmed","class_name":"Pre.K","house_id":"Eagles"},
      {"name":"Gamila Ramy","class_name":"Pre.K","house_id":"Oraca"},
      {"name":"Hamza Zayed","class_name":"Pre.K","house_id":"Rihno"},
      {"name":"Farah Husam","class_name":"Pre.K","house_id":"Eagles"}
    ];
    const CLASS_NAMES = [...new Set(FULL_STUDENT_DATA.map(s => s.class_name))].sort();

    // --- Icons (simple inline svgs) ---
    const Icons = {
      Star: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:24,height:24,fill:"none",stroke:"#fbbf24",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('polygon',{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})),
      Trash2: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:20,height:20,fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('path',{d:"M3 6h18"}),e('path',{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e('path',{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}),e('line',{x1:10,x2:10,y1:11,y2:17}),e('line',{x1:14,x2:14,y1:11,y2:17})),
      Lock: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:44,height:44,fill:"none",stroke:"red",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('rect',{width:30,height:16,x:7,y:19,rx:2,ry:2}),e('path',{d:"M15 19V11a9 9 0 0 1 18 0v8"}))
    };

    // --- Classroom integration helpers (inside same file for drop-in) ---
    async function signInWithGoogleForClassroom() {
      const auth = getAuth();
      const provider = new GoogleAuthProvider();
      provider.addScope('https://www.googleapis.com/auth/classroom.courses.readonly');
      provider.addScope('https://www.googleapis.com/auth/classroom.rosters.readonly');
      // Optional: request profile and email (already default)
      try {
        const result = await signInWithPopup(auth, provider);
        // credential may be available as GoogleAuthProvider.credentialFromResult(result)
        let credential;
        try { credential = GoogleAuthProvider.credentialFromResult(result); } catch (e) { credential = null; }
        const accessToken = (credential && credential.accessToken) || (result?.credential?.accessToken) || null;
        return { accessToken, user: result.user };
      } catch (err) {
        console.error('Classroom sign-in error', err);
        throw err;
      }
    }

    async function classroomApiGet(path, accessToken) {
      const base = 'https://classroom.googleapis.com/v1';
      const url = `${base}${path}`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}`, Accept: 'application/json' }});
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Classroom API error ${res.status}: ${text}`);
      }
      return res.json();
    }

    async function fetchCourses(accessToken) {
      const data = await classroomApiGet('/courses?courseStates=ACTIVE&pageSize=200', accessToken);
      return data.courses || [];
    }

    async function fetchCourseStudents(courseId, accessToken) {
      const data = await classroomApiGet(`/courses/${encodeURIComponent(courseId)}/students?pageSize=500`, accessToken);
      return data.students || [];
    }

    async function syncCoursesToFirestore(accessToken, db, appId = 'house-system-v1') {
      const courses = await fetchCourses(accessToken);
      for (const course of courses) {
        const docId = String(course.id);
        const payload = {
          id: course.id || docId,
          name: course.name || '',
          section: course.section || '',
          description: course.description || '',
          ownerId: course.ownerId || '',
          courseState: course.courseState || '',
          creationTime: course.creationTime || '',
          updateTime: course.updateTime || ''
        };
        await setDoc(doc(db, `/artifacts/${appId}/public/data/classrooms`, docId), payload);
      }
      return courses;
    }

    async function syncCourseStudentsToFirestore(courseId, accessToken, db, appId = 'house-system-v1') {
      const students = await fetchCourseStudents(courseId, accessToken);
      const normalized = (students || []).map(s => {
        const profile = s.profile || {};
        return {
          id: s.userId || (profile.emailAddress || '').replace(/[^a-zA-Z0-9@._-]/g, ''),
          name: (profile.name && (profile.name.fullName || `${profile.name.givenName || ''} ${profile.name.familyName || ''}`)) || '',
          email: profile.emailAddress || '',
          userId: s.userId || '',
          profile
        };
      });
      const docId = `${courseId}__roster`;
      await setDoc(doc(db, `/artifacts/${appId}/public/data/classroom_students`, docId), {
        courseId,
        roster: normalized,
        updatedAt: new Date().toISOString()
      });
      return normalized;
    }

    async function syncAllCoursesAndRosters(accessToken, db, appId = 'house-system-v1') {
      const courses = await fetchCourses(accessToken);
      const results = [];
      for (const course of courses) {
        await setDoc(doc(db, `/artifacts/${appId}/public/data/classrooms`, String(course.id)), {
          id: course.id, name: course.name || '', section: course.section || ''
        });
        const roster = await syncCourseStudentsToFirestore(course.id, accessToken, db, appId);
        results.push({ course: course.id, rosterCount: roster.length });
      }
      return results;
    }

    // --- UI Components ---

    // Simple loading/charts components rely on window.Recharts
    const HouseLeaderboard = ({ houses }) => {
      const RC = window.Recharts;
      if (!RC || !RC.BarChart) return e('div', { className: "p-6 text-center" }, "Loading Charts...");
      const sorted = [...(houses || [])].sort((a,b) => (b.total_points||0) - (a.total_points||0));
      const chartData = sorted.map(h => ({ name: h.name, Points: h.total_points || 0, fill: (HOUSE_SEED_DATA.find(x=>x.name===h.name)?.color||'#888') }));
      return e('div', { className: "p-6 max-w-6xl mx-auto" },
        e('div', { className: "grid grid-cols-2 md:grid-cols-4 gap-6 mb-6" },
          sorted.map((h,i) =>
            e('div', { key: h.id || h.name || i, className: "glass p-4 card-anim text-center" },
              i === 0 && e('div', { className: "flex justify-center mb-1" }, e(Icons.Star)),
              e('h3', { className: "font-bold text-lg", style: { color: HOUSE_SEED_DATA.find(x=>x.name===h.name)?.color || '#333' } }, h.name),
              e('div', { className: "text-3xl font-extrabold mt-2" }, (h.total_points || 0).toLocaleString()),
              e('div', { className: "text-xs text-gray-500 mt-1" }, HOUSE_SEED_DATA.find(x=>x.name===h.name)?.motto)
            )
          )
        ),
        e('div', { className: "glass p-4 rounded-xl shadow h-80" },
          RC.ResponsiveContainer ? e(RC.ResponsiveContainer, { width: "100%", height: "100%" },
            e(RC.BarChart, { data: chartData },
              e(RC.CartesianGrid, { strokeDasharray: "3 3" }),
              e(RC.XAxis, { dataKey: "name" }),
              e(RC.YAxis),
              e(RC.Tooltip),
              e(RC.Bar, { dataKey: "Points" },
                chartData.map((entry, idx) => e(RC.Cell, { key: `cell-${idx}`, fill: entry.fill }))
              )
            )
          ) : e('div', { className: "text-center p-6 text-gray-500" }, "Charts unavailable")
        )
      );
    };

    const Login = ({ db, appId, setIsStaff, setUserName, setIsAdmin, setActiveView }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [err, setErr] = useState('');
      const doLogin = async (ev) => {
        ev.preventDefault();
        try {
          const q = query(collection(db, `/artifacts/${appId}/public/data/users`));
          // simple client-side lookup with getDocs + filter (since we don't have complex indexing here)
          const snap = await getDocs(q);
          const found = snap.docs.map(d=>d.data()).find(u => u.email === email && u.password === password);
          if (found) {
            setIsStaff(true);
            setUserName(found.name || email);
            setIsAdmin(found.role === 'admin');
            setActiveView(found.role === 'admin' ? 'admin' : 'entry');
          } else {
            setErr("Invalid credentials");
          }
        } catch (err) {
          console.error(err);
          setErr("Login error");
        }
      };

      const signInWithGoogle = async () => {
        setErr('');
        try {
          const auth = getAuth();
          const provider = new GoogleAuthProvider();
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          const userEmail = user.email;
          // lookup in Firestore users
          const usersCol = collection(db, `/artifacts/${appId}/public/data/users`);
          const snap = await getDocs(usersCol);
          const found = snap.docs.map(d=>d.data()).find(u => u.email === userEmail);
          if (found) {
            setIsStaff(found.role === 'staff' || found.role === 'admin');
            setIsAdmin(found.role === 'admin');
            setUserName(found.name || user.displayName || userEmail);
            setActiveView(found.role === 'admin' ? 'admin' : 'entry');
          } else {
            setErr("User not authorized. Please contact admin.");
            await signOut(getAuth());
          }
        } catch (error) {
          console.error('Google sign-in failed:', error);
          setErr("Google sign-in failed: " + (error.message || error));
        }
      };

      return e('div', { className: "flex items-center justify-center min-h-screen" },
        e('form', { onSubmit: doLogin, className: "glass p-8 rounded-xl shadow-lg w-96 space-y-4" },
          e('h2', { className: "text-2xl font-bold text-center" }, "Staff Login"),
          err && e('div', { className: "text-red-500 text-sm text-center" }, err),
          e('input', { className: "w-full border p-2 rounded", placeholder: "Email", value: email, onChange: e=>setEmail(e.target.value) }),
          e('input', { className: "w-full border p-2 rounded", type:"password", placeholder: "Password", value: password, onChange: e=>setPassword(e.target.value) }),
          e('button', { className: "glassy-btn w-full" }, "Login"),
          e('div', { className: "text-center text-sm text-gray-500 py-2" }, "Or"),
          e('button', { type: 'button', onClick: signInWithGoogle, className: "w-full border py-2 rounded flex items-center justify-center gap-2 bg-white" },
            e('img', { src: 'https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg', alt: 'Google', className: 'w-5 h-5' }),
            e('span', null, 'Sign in with Google')
          ),
          e('div', { className: "text-xs text-gray-400 text-center" }, "Try: teacher@school.edu / password123")
        )
      );
    };

    const EntryView = ({ allStudents, rubric, db, appId, userName }) => {
      const [selectedClass, setSelectedClass] = useState(CLASS_NAMES[0]);
      const [selectedStudent, setSelectedStudent] = useState(null);
      const [studentSearch, setStudentSearch] = useState('');
      const [statusMessage, setStatusMessage] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const filtered = useMemo(() => {
        let list = (allStudents || []).filter(s => s.class_name === selectedClass).sort((a,b)=>a.name.localeCompare(b.name));
        if (studentSearch) list = list.filter(s => s.name.toLowerCase().includes(studentSearch.toLowerCase()));
        return list;
      }, [allStudents, selectedClass, studentSearch]);

      const handleAward = async (item) => {
        if (!selectedStudent) return;
        setIsLoading(true);
        try {
          const basePath = `/artifacts/${appId}/public/data`;
          await runTransaction(getFirestore(), async (t) => {
            const sRef = doc(getFirestore(), `${basePath}/students`, selectedStudent.id);
            const hRef = doc(getFirestore(), `${basePath}/houses`, selectedStudent.house_id);
            const sDoc = await t.get(sRef);
            const hDoc = await t.get(hRef);
            if (!sDoc.exists() || !hDoc.exists()) throw new Error('Missing student or house');
            t.update(sRef, { current_points: increment(item.points) });
            t.update(hRef, { total_points: increment(item.points) });
            t.set(doc(collection(getFirestore(), `${basePath}/transactions`)), {
              action: item.action,
              points: item.points,
              timestamp: new Date().toISOString(),
              awardedBy: userName,
              studentName: selectedStudent.name,
              houseId: selectedStudent.house_id,
              category: item.category
            });
          });
          setStatusMessage(`✅ ${item.points>0?'+':''}${item.points} points to ${selectedStudent.name}`);
          setTimeout(()=>setStatusMessage(''), 3000);
        } catch (err) {
          console.error(err);
          setStatusMessage('❌ Error awarding points');
        }
        setIsLoading(false);
        setSelectedStudent(null);
      };

      return e('div', { className: "p-6 max-w-6xl mx-auto" },
        e('div', { className: "flex justify-between mb-4 items-center" },
          e('h2', { className: "text-2xl font-bold" }, "Point Entry"),
          e('span', { className: "bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm" }, userName || 'Staff')
        ),
        statusMessage && e('div', { className: "glass text-center py-2 mb-4 font-semibold" }, statusMessage),
        e('div', { className: "grid lg:grid-cols-3 gap-6" },
          e('div', { className: "glass p-4" },
            e('label', null, "Class"),
            e('select', { className: "w-full border p-2 rounded mb-3", value: selectedClass, onChange: e=>{ setSelectedClass(e.target.value); setSelectedStudent(null); } },
              CLASS_NAMES.map(c => e('option', { key: c, value: c }, c))
            ),
            e('input', { className: "w-full border p-2 rounded mb-3", placeholder: "Search student...", value: studentSearch, onChange: e=>setStudentSearch(e.target.value) }),
            e('div', { className: "h-80 overflow-y-auto space-y-2" },
              filtered.map(s => e('div', {
                key: s.id, onClick: ()=>setSelectedStudent(s),
                className: `p-3 rounded border cursor-pointer flex justify-between items-center ${selectedStudent?.id === s.id ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}`
              }, e('div', null, e('div',{className:"font-bold"},s.name), e('div',{className:"text-xs"}, s.house_id)), e('div', {className:"font-bold"}, s.current_points || 0)))
            )
          ),
          e('div', { className: "lg:col-span-2 space-y-4" },
            e('div', { className: "glass p-4 rounded-xl" },
              e('h3', { className: "font-bold text-green-700 mb-2" }, "Award Points"),
              e('div', { className: "grid grid-cols-2 gap-3" },
                RUBRIC_SEED_DATA.filter(r => !r.is_miss_out).map(r => e('button', {
                  key: r.action, onClick: ()=>handleAward(r), disabled: !selectedStudent || isLoading,
                  className: `p-3 rounded border text-left ${!selectedStudent && 'opacity-50'}`
                }, e('div', { className: "flex justify-between" }, e('span', null, `+${r.points}`), e('span', { className: "text-xs text-gray-400" }, r.category)), e('div', { className: "text-sm font-bold" }, r.action)))
              )
            ),
            e('div', { className: "glass p-4 rounded-xl" },
              e('h3', { className: "font-bold text-red-700 mb-2" }, "Deduct / Miss-Out"),
              e('div', { className: "grid grid-cols-2 gap-3" },
                RUBRIC_SEED_DATA.filter(r => r.is_miss_out).map(r => e('button', {
                  key: r.action, onClick: ()=>handleAward(r), disabled: !selectedStudent || isLoading,
                  className: `p-3 rounded border text-left ${!selectedStudent && 'opacity-50'}`
                }, e('div', { className: "flex justify-between" }, e('span', null, r.points), e('span', { className: "text-xs text-gray-400" }, r.category)), e('div', { className: "text-sm font-bold" }, r.action)))
              )
            )
          )
        )
      );
    };

    // Admin view includes Classroom import panel
    const AdminView = ({ db, appId, transactions, usersList, houses }) => {
      const [nu, setNu] = useState({ name:'', email:'', password:'', role:'staff' });
      const [msg, setMsg] = useState('');
      const [showClassroomModal, setShowClassroomModal] = useState(false);
      const [classroomCourses, setClassroomCourses] = useState([]);
      const [selectedCourseIds, setSelectedCourseIds] = useState(new Set());
      const [classroomStatus, setClassroomStatus] = useState('');
      const RC = window.Recharts;

      const handleCreateUser = async (user) => {
        const id = user.email.replace(/[^a-zA-Z0-9]/g, '_');
        await setDoc(doc(db, `/artifacts/${appId}/public/data/users`, id), user);
        setMsg('User created');
        setNu({ name:'', email:'', password:'', role:'staff' });
        setTimeout(()=>setMsg(''),1500);
      };

      const handleDeleteUser = async (email) => {
        if (!confirm('Delete user?')) return;
        await deleteDoc(doc(db, `/artifacts/${appId}/public/data/users`, email.replace(/[^a-zA-Z0-9]/g, '_')));
        setMsg('User removed');
        setTimeout(()=>setMsg(''),1200);
      };

      const openClassroomModal = async () => {
        setClassroomStatus('Signing in & fetching courses...');
        try {
          const { accessToken } = await signInWithGoogleForClassroom();
          if (!accessToken) throw new Error('No access token received; ensure authorized domain + Classroom API enabled');
          const courses = await fetchCourses(accessToken);
          setClassroomCourses(courses || []);
          setClassroomStatus(`Fetched ${courses.length} courses`);
          setShowClassroomModal(true);
        } catch (err) {
          console.error(err);
          setClassroomStatus('Classroom sign-in failed: ' + (err.message || err));
          setTimeout(()=>setClassroomStatus(''), 5000);
        }
      };

      const toggleCourseSelection = (courseId) => {
        const next = new Set(selectedCourseIds);
        if (next.has(courseId)) next.delete(courseId); else next.add(courseId);
        setSelectedCourseIds(next);
      };

      const syncSelectedCourses = async () => {
        if (!selectedCourseIds.size) { alert('Select at least one course'); return; }
        setClassroomStatus('Syncing selected courses...');
        try {
          const { accessToken } = await signInWithGoogleForClassroom();
          for (const id of selectedCourseIds) {
            await syncCourseStudentsToFirestore(id, accessToken, db, appId);
            await setDoc(doc(db, `/artifacts/${appId}/public/data/classrooms`, String(id)), { syncedAt: new Date().toISOString() }, { merge: true });
          }
          setClassroomStatus('Selected courses synced to Firestore');
          setSelectedCourseIds(new Set());
          setShowClassroomModal(false);
          setTimeout(()=>setClassroomStatus(''),2000);
        } catch (err) {
          console.error(err);
          setClassroomStatus('Sync failed: ' + (err.message || err));
        }
      };

      const syncAll = async () => {
        setClassroomStatus('Full sync started...');
        try {
          const { accessToken } = await signInWithGoogleForClassroom();
          await syncAllCoursesAndRosters(accessToken, db, appId);
          setClassroomStatus('All courses and rosters synced.');
          setTimeout(()=>setClassroomStatus(''),2000);
        } catch (err) {
          console.error(err);
          setClassroomStatus('Sync failed: ' + (err.message || err));
        }
      };

      const housePie = (houses || []).map((h) => ({ name: h.name, value: h.total_points || 0, fill: HOUSE_SEED_DATA.find(x=>x.name===h.name)?.color || '#777' }));

      return e('div', { className: "p-6 max-w-6xl mx-auto space-y-6" },
        e('h2', { className: "text-2xl font-bold" }, "Admin Dashboard"),
        msg && e('div', { className: "glass p-2 text-center font-semibold" }, msg),
        e('div', { className: "grid md:grid-cols-3 gap-6" },
          e('div', { className: "glass p-4 card-anim" },
            e('h3', { className: "font-bold mb-2" }, "Classroom Import"),
            e('p', { className: "text-sm text-gray-600 mb-3" }, "Import classes and rosters from Google Classroom for your domain users."),
            e('div', { className: "flex gap-2" },
              e('button', { onClick: openClassroomModal, className: "glassy-btn" }, "Import from Google Classroom"),
              e('button', { onClick: syncAll, className: "px-4 py-2 border rounded" }, "Sync All")
            ),
            classroomStatus && e('div', { className: "text-sm text-gray-700 mt-2" }, classroomStatus)
          ),
          e('div', { className: "glass p-4 card-anim" },
            e('h3', { className: "font-bold mb-2" }, "House Distribution"),
            RC && RC.ResponsiveContainer ? e(RC.ResponsiveContainer, { width:"100%", height:180 },
              e(RC.PieChart, null,
                e(RC.Pie, { data: housePie, dataKey:"value", nameKey:"name", cx:"50%", cy:"50%", outerRadius:60, label:true },
                  housePie.map((entry, i) => e(RC.Cell, { key:`cell-${i}`, fill: entry.fill }))
                ),
                e(RC.Tooltip), e(RC.Legend)
              )
            ) : e('div', null, "Charts loading")
          ),
          e('div', { className: "glass p-4 card-anim" },
            e('h3', { className: "font-bold mb-2" }, "Recent Activity"),
            e('div', { className: "max-h-40 overflow-y-auto space-y-2" },
              (transactions || []).slice(0,40).map(t => e('div', { key: t.id, className: "flex justify-between text-sm border-b pb-1" },
                e('div', null, e('span', { className: "font-bold" }, t.studentName), e('span', { className: "text-gray-400 ml-1" }, `(${t.action})`)),
                e('div', { className: t.points>0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold' }, t.points)
              ))
            )
          )
        ),
        // Manage users section
        e('div', { className: "glass p-4 card-anim" },
          e('h3', { className: "font-bold mb-3" }, "Manage Users"),
          e('form', { onSubmit: ev => { ev.preventDefault(); if (!nu.email || !nu.name) return; handleCreateUser(nu); }, className: "grid md:grid-cols-6 gap-2 items-center" },
            e('input', { placeholder: "Name", required:true, value:nu.name, onChange: ev=>setNu({...nu, name:ev.target.value}), className: "p-2 border rounded col-span-2" }),
            e('input', { placeholder: "Email", required:true, value:nu.email, onChange: ev=>setNu({...nu, email:ev.target.value}), className: "p-2 border rounded col-span-2" }),
            e('select', { value: nu.role, onChange: ev=>setNu({...nu, role:ev.target.value}), className: "p-2 border rounded" },
              e('option',{value:"staff"},"Staff"), e('option',{value:"admin"},"Admin")
            ),
            e('button', { type:"submit", className: "glassy-btn col-span-1" }, "+ Add")
          ),
          e('div', { className: "mt-4 overflow-auto" },
            e('table', { className: "min-w-full text-sm" },
              e('thead', { className: "bg-gray-100" }, e('tr', null, e('th',{className:"p-2"},"Name"), e('th',{className:"p-2"},"Email"), e('th',{className:"p-2"},"Role"), e('th',{className:"p-2"},"Del"))),
              e('tbody', null, (usersList || []).map(u =>
                e('tr', { key: u.id, className: "border-b" }, e('td',{className:"p-2 font-bold"}, u.name), e('td',{className:"p-2"}, u.email), e('td',{className:"p-2"}, u.role), e('td',{className:"p-2"}, e('button',{onClick:()=>handleDeleteUser(u.email), className:"text-red-600"}, e(Icons.Trash2))))
              ))
            )
          )
        ),

        // Classroom modal
        showClassroomModal && e('div', { className: "modal-backdrop" },
          e('div', { className: "glass modal p-6" },
            e('div', { className: "flex justify-between items-center mb-4" }, e('h3', { className: "text-lg font-bold" }, "Select Courses to Import"), e('button', { onClick: ()=> setShowClassroomModal(false), className: "px-3 py-1 border rounded" }, "Close")),
            e('div', { className: "max-h-72 overflow-y-auto space-y-2" },
              (classroomCourses || []).map(c => e('label', { key: c.id, className: "flex items-center gap-3 p-2 border rounded" },
                e('input', { type: "checkbox", checked: selectedCourseIds.has(String(c.id)), onChange: ()=> toggleCourseSelection(String(c.id)) }),
                e('div', null, e('div', { className: "font-bold" }, c.name), e('div', { className: "text-xs text-gray-500" }, c.section || ''))
              ))
            ),
            e('div', { className: "flex gap-3 justify-end mt-4" },
              e('button', { onClick: syncSelectedCourses, className: "glassy-btn" }, "Sync Selected"),
              e('button', { onClick: ()=> { setSelectedCourseIds(new Set()); setShowClassroomModal(false); }, className: "px-4 py-2 border rounded" }, "Cancel")
            )
          )
        )
      );
    };

    // --- Main App ---
    const App = () => {
      const [db, setDb] = useState(null);
      const [isAuthReady, setIsAuthReady] = useState(false);
      const [userId, setUserId] = useState(null);
      const [permissionError, setPermissionError] = useState(false);
      const [isStaff, setIsStaff] = useState(false);
      const [isAdmin, setIsAdmin] = useState(false);
      const [activeView, setActiveView] = useState('leaderboard');
      const [userName, setUserName] = useState('');
      const [houses, setHouses] = useState([]);
      const [rubric, setRubric] = useState([]);
      const [allStudents, setAllStudents] = useState([]);
      const [transactions, setTransactions] = useState([]);
      const [usersList, setUsersList] = useState([]);

      useEffect(() => {
        const app = initializeApp(firebaseConfig);
        const fAuth = getAuth(app);
        const firestore = getFirestore(app);
        setDb(firestore);

        const init = async () => {
          try {
            if (fAuth.currentUser) await signOut(fAuth);
            await signInAnonymously(fAuth);
          } catch (e) {
            console.error('Auth init failed', e);
          }
        };
        init();

        onAuthStateChanged(fAuth, (user) => {
          if (user) { setUserId(user.uid); setIsAuthReady(true); }
          else setIsAuthReady(true);
        });
      }, []);

      useEffect(() => {
        if (!db || !userId || permissionError) return;
        const basePath = `/artifacts/${appId}/public/data`;
        const handleSnapshotError = (err) => { if (err?.code === 'permission-denied') setPermissionError(true); };

        // Seed if needed
        (async () => {
          try {
            const housesSnap = await getDocs(collection(db, `${basePath}/houses`));
            if (housesSnap.empty) {
              const batch = writeBatch(db);
              // seed houses
              HOUSE_SEED_DATA.forEach(h => batch.set(doc(db, `${basePath}/houses`, h.name), { ...h, total_points: 0 }));
              // seed rubric
              RUBRIC_SEED_DATA.forEach(r => batch.set(doc(db, `${basePath}/rubric`, r.action.replace(/[^a-zA-Z0-9]/g, '_')), r));
              // seed users
              INITIAL_USERS.forEach(u => batch.set(doc(db, `${basePath}/users`, u.email.replace(/[^a-zA-Z0-9]/g, '_')), u));
              // seed students
              FULL_STUDENT_DATA.forEach(s => {
                const safeId = `${s.name.replace(/[^a-zA-Z0-9]/g, '')}_${s.class_name.replace(/[^a-zA-Z0-9]/g, '')}`;
                batch.set(doc(db, `${basePath}/students`, safeId), { ...s, current_points: 0, id: safeId });
              });
              await batch.commit();
            }
          } catch (err) {
            if (err?.code === 'permission-denied') setPermissionError(true);
            console.error('Seeding error', err);
          }
        })();

        const unsubH = onSnapshot(collection(db, `${basePath}/houses`), s => setHouses(s.docs.map(d=>({ id:d.id, ...d.data() }))), handleSnapshotError);
        const unsubR = onSnapshot(collection(db, `${basePath}/rubric`), s => setRubric(s.docs.map(d=>({ id:d.id,...d.data() }))), handleSnapshotError);
        const unsubS = onSnapshot(collection(db, `${basePath}/students`), s => setAllStudents(s.docs.map(d=>({ id:d.id,...d.data() }))), handleSnapshotError);
        const unsubT = onSnapshot(query(collection(db, `${basePath}/transactions`), orderBy('timestamp','desc'), limit(50)), s => setTransactions(s.docs.map(d=>({ id:d.id,...d.data() }))), handleSnapshotError);

        let unsubU = () => {};
        if (isAdmin) unsubU = onSnapshot(collection(db, `${basePath}/users`), s => setUsersList(s.docs.map(d=>({ id:d.id,...d.data() }))), handleSnapshotError);

        return () => { unsubH(); unsubR(); unsubS(); unsubT(); unsubU(); };
      }, [db, userId, isAdmin, permissionError]);

      const handleLogout = () => { setIsStaff(false); setIsAdmin(false); setUserName(''); setActiveView('leaderboard'); };

      if (permissionError) {
        return e('div', { className: "flex items-center justify-center min-h-screen p-4" },
          e('div', { className: "glass p-8 rounded-xl text-center max-w-md" },
            e(Icons.Lock),
            e('h2', { className: "text-2xl font-bold mt-4 mb-2" }, "Permission Denied"),
            e('p', null, "Your Firestore Rules are blocking access. For quick testing set rules to open (not for production):"),
            e('pre', { className: "text-xs bg-gray-900 text-white p-3 rounded mt-3", style: { whiteSpace: 'pre-wrap' } }, "rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}")
          )
        );
      }

      if (!isAuthReady) return e('div', { className: "flex items-center justify-center min-h-screen" }, "Loading...");

      return e('div', { className: "min-h-screen pb-12" },
        e('div', { className: "flex flex-col md:flex-row justify-between items-center p-4" },
          e('h1', { className: "text-2xl font-bold" }, "House System Tracker"),
          e('div', { className: "flex gap-2 mt-3 md:mt-0" },
            e('button', { onClick: ()=>setActiveView('entry'), className: "px-3 py-1 rounded bg-indigo-600 text-white" }, "Entry"),
            e('button', { onClick: ()=>setActiveView('leaderboard'), className: "px-3 py-1 rounded bg-yellow-400 text-black" }, "Leaderboard"),
            isAdmin && e('button', { onClick: ()=>setActiveView('admin'), className: "px-3 py-1 rounded bg-indigo-500 text-white" }, "Admin"),
            isStaff && e('button', { onClick: handleLogout, className: "px-3 py-1 rounded bg-red-200 text-red-800" }, "Logout")
          )
        ),
        activeView === 'leaderboard' && e(HouseLeaderboard, { houses }),
        activeView === 'entry' && (isStaff ? e(EntryView, { allStudents, rubric, db, appId, userName }) : e(Login, { db, appId, setIsStaff, setUserName, setIsAdmin, setActiveView })),
        activeView === 'admin' && e(AdminView, { db, appId, transactions, usersList, houses })
      );
    };

    // Render
    ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>