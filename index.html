<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>House System Tracker</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Recharts -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.2/dist/Recharts.min.js"></script>
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(115deg,#ece9e6 0,#ffffff 74%);
      min-height: 100vh;
    }
    .glass {
      background: rgba(255,255,255,0.82);
      backdrop-filter: blur(12px);
      box-shadow: 0 6px 40px 0 rgba(0,0,0,0.09);
      border-radius: 1.25rem;
      border: 1.5px solid rgba(200,200,200,0.3);
    }
    .glassy-btn {
      background: linear-gradient(90deg, #6366f1 0%, #2dd4bf 100%);
      color: white;
      border: none;
      padding: .75rem 1.5rem;
      border-radius: 9999px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(80,79,238,0.13);
      transition: background 0.3s, transform 0.2s;
    }
    .glassy-btn:hover {
      background: linear-gradient(90deg, #818cf8 0%, #5eead4 100%);
      transform: scale(1.04);
    }
    .dashboard-head {
      background: linear-gradient(95deg, #6366f1 0%, #2dd4bf 110%);
      color: white;
      box-shadow: 0 2px 14px rgba(80,79,238,0.13), 0 0px 1px rgba(44,44,44,.15);
    }
    .card-anim {
      transition: box-shadow 0.3s, transform 0.18s;
    }
    .card-anim:hover {
      box-shadow: 0 8px 35px rgba(80,79,238,0.14);
      transform: scale(1.025);
      z-index: 1;
    }
    .gradient-bg {
      background: linear-gradient(110deg, #fca311 0%, #4361ee 90%);
      color: white;
    }
    .text-glow {
      text-shadow: 0 5px 22px rgba(44,44,44,.08),0 1px 1px rgba(80,79,238,0.08);
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getFirestore, doc, onSnapshot, collection, query, updateDoc, increment, setDoc, getDocs, runTransaction, where, orderBy, limit, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const appId = "house-system-v1";
const firebaseConfig = {
  apiKey: "AIzaSyC1rWI1b87xeqHJtYmsRUL8Ruf33nJiQIM",
  authDomain: "house-system-f54a3.firebaseapp.com",
  projectId: "house-system-f54a3",
  storageBucket: "house-system-f54a3.appspot.com",
  messagingSenderId: "171645573652",
  appId: "1:171645573652:web:9942711f898071a66ba501"
};
const { useState, useEffect, useCallback, useMemo } = React;
const e = React.createElement;

// --- Data ---
const INITIAL_USERS = [
  { email: "teacher@school.edu", password: "password123", role: "staff", name: "Default Teacher" },
  { email: "admin@school.edu", password: "admin123", role: "admin", name: "System Admin" }
];
const HOUSE_SEED_DATA = [
  { name: 'Rihno', color: '#10b981', motto: "Strength in Unity" },
  { name: 'Cougar', color: '#3b82f6', motto: "Courage and Grace" },
  { name: 'Eagles', color: '#f59e0b', motto: "Soaring to Success" },
  { name: 'Oraca', color: '#ef4444', motto: "Passion and Precision" }
];
const RUBRIC_SEED_DATA = [
  { category: 'Academic', action: 'High test scores', points: 15, is_miss_out: false },
  { category: 'Behavior', action: 'Compassion: Act of kindness', points: 30, is_miss_out: false },
  { category: 'Behavior', action: 'Respect: Show respect & Good Manners', points: 30, is_miss_out: false },
  { category: 'Events', action: 'Winning a school competition', points: 20, is_miss_out: false },
  { category: 'Miss-Out', action: 'Misbehavior in events', points: -10, is_miss_out: true }
];
const FULL_STUDENT_DATA = [
  {"name": "Yaseen Aseem Saady", "class_name": "Grade 10", "house_id": "Eagles"},
  {"name": "Abdelrahman Bahaa", "class_name": "Grade 10", "house_id": "Cougar"},
  {"name": "Karma Mahmoud", "class_name": "Grade 9", "house_id": "Eagles"},
  {"name": "Reem Hossam", "class_name": "Grade 9", "house_id": "Oraca"},
  {"name": "Retal Mohamed", "class_name": "Grade 8", "house_id": "Rihno"},
  {"name": "Adam Ahmed", "class_name": "Grade 8", "house_id": "Cougar"},
  {"name": "Laila Mahmoud", "class_name": "Grade 7", "house_id": "Cougar"},
  {"name": "Lamis Ahmed", "class_name": "Grade 7", "house_id": "Rihno"},
  {"name": "Sara Mohamed", "class_name": "Grade 6", "house_id": "Rihno"},
  {"name": "Saeed Ahmed", "class_name": "Grade 6", "house_id": "Cougar"},
  {"name": "Adham Yousry", "class_name": "Grade 5", "house_id": "Oraca"},
  {"name": "Selim Mohamed", "class_name": "Grade 5", "house_id": "Oraca"},
  {"name": "Aseel Atef", "class_name": "Grade 4", "house_id": "Cougar"},
  {"name": "Layan Mohamed", "class_name": "Grade 4", "house_id": "Cougar"},
  {"name": "Yousef Mohamed", "class_name": "Grade 3", "house_id": "Cougar"},
  {"name": "Elaf Mohamed", "class_name": "Grade 3", "house_id": "Eagles"},
  {"name": "Anas Ahmed", "class_name": "Y2-B", "house_id": "Rihno"},
  {"name": "YOUSSEF MOHAMED", "class_name": "Y2-C", "house_id": "Eagles"},
  {"name": "Mourad Mohamed", "class_name": "Y2-A", "house_id": "Cougar"},
  {"name": "Laila Amr", "class_name": "Y1-E", "house_id": "Oraca"},
  {"name": "Asma Osman", "class_name": "Y1-D", "house_id": "Rihno"},
  {"name": "Adam Mohammed", "class_name": "Y1-C", "house_id": "Eagles"},
  {"name": "Ismail Muhammad", "class_name": "Y1-B", "house_id": "Cougar"},
  {"name": "Raheem Yasser", "class_name": "Y1-A", "house_id": "Oraca"},
  {"name": "Zain Ahmed", "class_name": "Pre.K", "house_id": "Eagles"},
  {"name": "Gamila Ramy", "class_name": "Pre.K", "house_id": "Oraca"},
  {"name": "Hamza Zayed", "class_name": "Pre.K", "house_id": "Rihno"},
  {"name": "Farah Husam", "class_name": "Pre.K", "house_id": "Eagles"}
];
const CLASS_NAMES = [...new Set(FULL_STUDENT_DATA.map(s => s.class_name))].sort();

// --- ICONS ---
const Icons = {
  Star: ({ className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", width: "32", height: "32", fill: "none", stroke: "#fbbf24", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, e('polygon', { points: "12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" })),
  Trash2: () => e('svg', {xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},e('path',{d:"M3 6h18"}),e('path',{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e('path',{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}),e('line',{x1:"10",x2:"10",y1:"11",y2:"17"}),e('line',{x1:"14",x2:"14",y1:"11",y2:"17"})),
  Lock: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:"44",height:"44",fill:"none",stroke:"red",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},e('rect',{width:"30",height:"16",x:"7",y:"19",rx:"2",ry:"2"}),e('path',{d:"M15 19V11a9 9 0 0 1 18 0v8"}))
};

// --- COMPONENTS ---
// Leaderboard
const HouseLeaderboard = ({ houses }) => {
  const RC = window.Recharts;
  if (!RC || !RC.BarChart) return e('div', {className: "p-6 text-center"}, "Loading Charts...");
  // Style - sort houses by points descending for bar chart
  const sorted = [...houses].sort((a,b) => b.total_points-b.total_points);
  const chartData = sorted.map(h => ({
    name: h.name, Points: h.total_points,
    fill: HOUSE_SEED_DATA.find(s => s.name === h.name)?.color || '#888'
  }));
  return e('div', {className:"p-6 max-w-6xl mx-auto"},
    e('div', {className:"grid grid-cols-2 md:grid-cols-4 gap-6 mb-8"},
      sorted.map((h,i)=>
        e('div', {key:h.id,className:`glass card-anim p-6 text-center ${i===0?'ring-2 ring-yellow-400':''}`},
          i===0 && e('div', {className:"flex justify-center mb-1"}, e(Icons.Star,{className:"h-7 w-7"})),
          e('h3', {className:"font-bold text-xl text-glow mb-1",style:{color:chartData[i]?.fill}}, h.name),
          e('div', {className:"text-3xl md:text-4xl font-black text-gray-800"}, h.total_points?.toLocaleString()||"0"),
          e('div', {className:"text-xs text-gray-500"}, HOUSE_SEED_DATA.find(s=>s.name===h.name)?.motto)
        )
      )
    ),
    e('div',{className:"glass border px-4 py-4 rounded-xl shadow h-80"},
      RC.ResponsiveContainer
        ? e(RC.ResponsiveContainer, {width:"100%", height:"100%"},
            e(RC.BarChart, {data:chartData},
              e(RC.CartesianGrid, {strokeDasharray:"3 3"}),
              e(RC.XAxis, {dataKey:"name"}),
              e(RC.YAxis),
              e(RC.Tooltip),
              e(RC.Bar, {dataKey:"Points"},
                chartData.map((entry,i) => e(RC.Cell,{key:`cell-${i}`,fill:entry.fill}))
              )
            )
          )
        : e('div',{className:"text-center pt-10 text-gray-500"},"Charts failed to load.")
    )
  );
};

// Entry
const EntryView = ({ allStudents, rubric, db, appId, userName }) => {
  const [selectedClass, setSelectedClass] = useState(CLASS_NAMES[0]);
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [studentSearch, setStudentSearch] = useState('');
  const [statusMessage, setStatusMessage] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const filtered = useMemo(() => {
    let list = allStudents.filter(s => s.class_name === selectedClass).sort((a,b) => a.name.localeCompare(b.name));
    if(studentSearch) list = list.filter(s => s.name.toLowerCase().includes(studentSearch.toLowerCase()));
    return list;
  }, [allStudents, selectedClass, studentSearch]);
  const handleAward = async (item) => {
    if(!selectedStudent) return;
    setIsLoading(true);
    try {
      const basePath = `/artifacts/${appId}/public/data`;
      await runTransaction(db, async (t) => {
        const sRef = doc(db, `${basePath}/students`, selectedStudent.id);
        const hRef = doc(db, `${basePath}/houses`, selectedStudent.house_id);
        const sDoc = await t.get(sRef);
        const hDoc = await t.get(hRef);
        if(!sDoc.exists() || !hDoc.exists()) throw "Missing";
        t.update(sRef, { current_points: increment(item.points) });
        t.update(hRef, { total_points: increment(item.points) });
        t.set(doc(collection(db, `${basePath}/transactions`)), {
          action: item.action, points: item.points, timestamp: new Date().toISOString(), awardedBy: userName,
          studentName: selectedStudent.name, houseId: selectedStudent.house_id, category: item.category
        });
      });
      setStatusMessage(`âœ… ${item.points>0?'+':''}${item.points} points to ${selectedStudent.name}`);
      setTimeout(()=>setStatusMessage(''), 3000);
    } catch(e) { setStatusMessage("âŒ Error"); console.error(e); }
    setIsLoading(false);
    setSelectedStudent(null);
  };

  return e('div', {className:"p-6 xl:max-w-6xl mx-auto"},
    e('div', {className:"flex justify-between items-center mb-4"},
      e('h2', {className:"text-xl font-bold gradient-bg px-6 py-2 rounded-2xl shadow text-glow"}, "Award & Deduct Points"),
      e('span', {className:"bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm"}, userName)
    ),
    statusMessage && e('div', {className:"glass my-2 text-center py-2 text-lg font-bold", style:{color:statusMessage.includes('Error')?'red':'green'}}, statusMessage),
    e('div', {className:"grid lg:grid-cols-3 gap-6 mb-8"},
      e('div', {className:"glass p-4 border shadow"},
        e('label', {className:"block text-sm font-bold text-gray-700 mb-1"}, "Class/Grade"),
        e('select', {className:"w-full border p-2 rounded mb-3", value:selectedClass, onChange:e=>{setSelectedClass(e.target.value);setSelectedStudent(null);}},
          CLASS_NAMES.map(c=>e('option',{key:c,value:c},c))
        ),
        e('input', {className:"w-full border p-2 rounded mb-3", placeholder:"Search Student...", value:studentSearch, onChange:e=>setStudentSearch(e.target.value)}),
        e('div', {className:"h-80 overflow-y-auto space-y-2"},
          filtered.map(s => {
            const color = HOUSE_SEED_DATA.find(h => h.name === s.house_id)?.color || "#aaa";
            return e('div', {
              key:s.id, onClick:()=>setSelectedStudent(s),
              className:`p-3 rounded-xl border cursor-pointer flex justify-between items-center transition ${selectedStudent?.id===s.id?"bg-gradient-to-r from-indigo-500 via-cyan-400 to-lime-300 text-white":"hover:bg-blue-50"}`
            },
              e('div',null,
                e('div', {className:"font-bold"}, s.name),
                e('div', {className:"text-xs mt-1 px-2 py-0.5 rounded-full", style:{background:color,color:"white"}}, s.house_id)
              ),
              e('div', {className:"font-bold"}, s.current_points)
            )
          })
        )
      ),
      e('div', {className:"lg:col-span-2 space-y-4"},
        e('div', {className:"glass border p-4 rounded-xl shadow mb-3"},
          e('h3', {className:"font-bold text-green-700 mb-2"}, "Award Points"),
          e('div', {className:"grid grid-cols-2 gap-3"},
            RUBRIC_SEED_DATA.filter(r=>!r.is_miss_out).map(r=>e('button',{
              key:r.action, onClick:()=>handleAward(r), disabled:!selectedStudent||isLoading,
              className:`p-3 rounded border text-left card-anim ${!selectedStudent&&'opacity-50'} transition focus:ring-2 focus:ring-green-300`,
              style:{background:selectedStudent?'#e0fbe7':'', color:'#276749'}
            },
              e('div',{className:"flex justify-between items-center"},
                e('span',{className:"font-bold text-xl text-green-600"}, `+${r.points}`),
                e('span',{className:"text-xs font-bold text-gray-400"}, r.category)
              ),
              e('div',{className:"text-xs font-bold mt-1"}, r.action)
            ))
          )
        ),
        e('div', {className:"glass border p-4 rounded-xl shadow"},
          e('h3', {className:"font-bold text-red-700 mb-2"}, "Deduct Points"),
          e('div', {className:"grid grid-cols-2 gap-3"},
            RUBRIC_SEED_DATA.filter(r=>r.is_miss_out).map(r=>e('button',{
              key:r.action, onClick:()=>handleAward(r), disabled:!selectedStudent||isLoading,
              className:`p-3 rounded border text-left card-anim ${!selectedStudent&&'opacity-50'} transition focus:ring-2 focus:ring-red-300`,
              style:{background:selectedStudent?'#ffe3e3':'', color:'#a61e4d'}
            },
              e('div',{className:"flex justify-between items-center"},
                e('span',{className:"font-bold text-xl text-red-600"}, r.points),
                e('span',{className:"text-xs font-bold text-gray-400"}, r.category)
              ),
              e('div',{className:"text-xs font-bold mt-1"}, r.action)
            ))
          )
        )
      )
    )
  );
};

// Admin
const AdminView = ({ db, appId, transactions, usersList, houses }) => {
  const [nu, setNu] = useState({name:"", email:"", password:"", role:"staff"});
  const [msg, setMsg] = useState('');
  const RC = window.Recharts;

  const handleCreateUser = async (user) => {
    const id = user.email.replace(/[^a-zA-Z0-9]/g, '_');
    await setDoc(doc(db, `/artifacts/${appId}/public/data/users`, id), user);
    setMsg('User added!');
    setNu({name:"", email:"", password:"", role:"staff"});
    setTimeout(()=>setMsg(''),1500);
  };
  const handleDeleteUser = async (email) => {
    if(window.confirm('Remove this user?')) {
      await deleteDoc(doc(db, `/artifacts/${appId}/public/data/users`, email.replace(/[^a-zA-Z0-9]/g, '_')));
      setMsg('User removed!');
      setTimeout(()=>setMsg(''),1200);
    }
  };
  // Pie chart data
  const housePie = houses.map((h,i) => ({
    name: h.name,
    value: h.total_points,
    fill: HOUSE_SEED_DATA.find(x=>x.name===h.name)?.color||"#999"
  }));

  return e('div', {className:"p-6 max-w-6xl mx-auto space-y-10"},
    e('h2', {className:"dashboard-head px-8 py-3 rounded-3xl font-bold text-center text-3xl shadow text-glow mb-8"}, "Admin Dashboard"),
    msg && e('div', {className:"glass text-center py-2 text-lg font-bold", style:{color:"blue"}}, msg),
    e('div', {className:"grid grid-cols-1 md:grid-cols-2 gap-8"},
      // Pie Chart
      e('div',{className:"glass p-6 shadow-xl"},
        e('h3',{className:"font-bold mb-2 text-lg gradient-bg px-3 py-1 rounded-xl text-glow"},"House Distribution"),
        RC && RC.ResponsiveContainer &&
          e(RC.ResponsiveContainer, {width:"100%",height:220},
            e(RC.PieChart, null,
              e(RC.Pie,{data:housePie,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:true},
                housePie.map((entry,i) =>
                  e(RC.Cell,{key:entry.name,fill:entry.fill})
                )
              ),
              e(RC.Tooltip),e(RC.Legend)
            )
          )
      ),
      // Activity log/history
      e('div',{className:"glass p-6 shadow-xl overflow-auto"},
        e('h3',{className:"font-bold mb-2 text-lg gradient-bg px-3 py-1 rounded-xl text-glow"},"Recent Activity"),
        e('div',{className:"space-y-2 max-h-64 overflow-y-auto"},
          transactions.map(t=>
            e('div',{key:t.id,className:"flex justify-between items-center text-sm border-b pb-1"},
              e('div',null,
                e('span',{className:"font-bold"},t.studentName), " ",
                e('span',{className:"text-gray-400"},`(${t.action})`)
              ),
              e('div',{className:t.points>0?'text-green-600 font-bold':'text-red-600 font-bold'},t.points),
              e('span',{className:"ml-2 text-xs text-gray-400 "}, new Date(t.timestamp).toLocaleString())
            )
          )
        )
      )
    ),
    e('div',{className:"glass p-6 shadow-xl"},
      e('h3',{className:"font-bold mb-4 text-lg gradient-bg px-3 py-1 rounded-xl text-glow"},"Manage Users"),
      e('form',{onSubmit:ev=>{
        ev.preventDefault();
        if(!nu.email||!nu.name) return;
        handleCreateUser(nu);
      },className:"grid md:grid-cols-6 gap-2 items-center mb-5"},
        e('input',{placeholder:"Name",required:true,value:nu.name,onChange:ev=>setNu({...nu,name:ev.target.value}),className:"p-2 border rounded"}),
        e('input',{placeholder:"Email",required:true,value:nu.email,onChange:ev=>setNu({...nu,email:ev.target.value}),className:"p-2 border rounded"}),
        e('input',{placeholder:"Password",type:"password",value:nu.password,onChange:ev=>setNu({...nu,password:ev.target.value}),className:"p-2 border rounded"}),
        e('select',{value:nu.role,onChange:ev=>setNu({...nu,role:ev.target.value}),className:"p-2 border rounded"},
          e('option',{value:"staff"},"Staff"),
          e('option',{value:"admin"},"Admin")
        ),
        e('button',{type:"submit",className:"glassy-btn w-full col-span-2"},"+ Add User")
      ),
      e('div',{className:"overflow-auto"},
        e('table',{className:"min-w-full text-sm"},
          e('thead',{className:"bg-gray-100"},e('tr',null,
            e('th',{className:"p-2"},"Name"),e('th',{className:"p-2"},"Email"),e('th',{className:"p-2"},"Role"),e('th',{className:"p-2"},"Remove")
          )),
          e('tbody',null,
            usersList.map(u=>
              e('tr',{key:u.id,className:"border-b transition hover:bg-gray-50"},
                e('td',{className:"p-2 font-bold"},u.name),
                e('td',{className:"p-2"},u.email),
                e('td',{className:"p-2 text-center"},u.role),
                e('td',{className:"p-2 text-center"},e('button',{onClick:()=>handleDeleteUser(u.email),className:"text-red-600 hover:bg-red-100 px-2 py-1 rounded-lg"},e(Icons.Trash2)))
              )
            )
          )
        )
      )
    )
  );
};

// Login
const Login = ({ db, appId, setIsStaff, setUserName, setIsAdmin, setActiveView }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [err, setErr] = useState('');
  const doLogin = async (ev) => {
    ev.preventDefault();
    try {
      const q = query(collection(db, `/artifacts/${appId}/public/data/users`), where("email", "==", email), where("password", "==", password));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const uData = snap.docs[0].data();
        setIsStaff(true);
        setUserName(uData.name);
        setIsAdmin(uData.role === 'admin');
        setActiveView(uData.role === 'admin' ? 'admin' : 'entry');
      } else {
        setErr("Invalid credentials");
      }
    } catch (err) { setErr("Login error"); }
  };
  const signInWithGoogle = async () => {
    setErr('');
    try {
      const auth = getAuth();
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userEmail = user.email;
      const q = query(
        collection(db, `/artifacts/${appId}/public/data/users`),
        where('email', '==', userEmail)
      );
      const snap = await getDocs(q);
      if (!snap.empty) {
        const userData = snap.docs[0].data();
        setIsStaff(userData.role === 'staff' || userData.role === 'admin');
        setIsAdmin(userData.role === 'admin');
        setUserName(userData.name || user.displayName);
        setActiveView(userData.role === 'admin' ? 'admin' : 'entry');
      } else {
        setErr("User not authorized. Please contact admin.");
        await getAuth().signOut();
      }
    } catch (error) {
      setErr("Google sign-in failed: " + error.message);
    }
  };
  return e('div', {className:"flex justify-center items-center h-screen"},
    e('form', {onSubmit:doLogin, className:"glass border p-8 rounded-2xl shadow-lg w-96 space-y-4"},
      e('h2', {className:"text-2xl font-bold text-center gradient-bg px-4 py-2 rounded-xl text-glow"}, "Staff Login"),
      err && e('div', {className:"bg-red-100 text-red-500 text-sm text-center rounded py-1"}, err),
      e('input', {className:"w-full border p-2 rounded", placeholder:"Email", value:email, onChange:ev=>setEmail(ev.target.value)}),
      e('input', {className:"w-full border p-2 rounded", type:"password", placeholder:"Password", value:password, onChange:ev=>setPassword(ev.target.value)}),
      e('button', {className:"glassy-btn w-full mt-2"}, "Login"),
      e('div', {className:"relative my-4"}, 
        e('div', {className:"absolute inset-0 flex items-center"}, 
          e('div', {className:"w-full border-t border-gray-300"})
        ),
        e('div', {className:"relative flex justify-center text-sm"}, 
          e('span', {className:"px-2 bg-white text-gray-500"}, "Or")
        )
      ),
      e('button', {type:'button',onClick:signInWithGoogle,className:'w-full bg-white border border-gray-300 text-gray-700 py-2 rounded flex items-center justify-center space-x-2 hover:bg-gray-50'}, 
        e('img', {src:'https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg',alt:'Google',className:'w-5 h-5'}),
        e('span',null,'Sign in with Google')
      ),
      e('div', {className:"mt-4 text-xs text-gray-400 text-center"}, "Try: teacher@school.edu / password123")
    )
  );
};

// --- Main App
const App = () => {
  const [db, setDb] = useState(null), [isAuthReady, setIsAuthReady] = useState(false),
    [userId, setUserId] = useState(null), [permissionError, setPermissionError] = useState(false),
    [isStaff, setIsStaff] = useState(false), [isAdmin, setIsAdmin] = useState(false),
    [activeView, setActiveView] = useState('leaderboard'), [userName, setUserName] = useState('');
  const [houses, setHouses] = useState([]), [rubric, setRubric] = useState([]),
    [allStudents, setAllStudents] = useState([]), [transactions, setTransactions] = useState([]), [usersList, setUsersList] = useState([]);
  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const fAuth = getAuth(app);
    setDb(getFirestore(app));
    const initAuth = async () => {
      try {
        if (fAuth.currentUser) await signOut(fAuth);
        await signInAnonymously(fAuth);
      } catch(e) {}
    };
    initAuth();
    onAuthStateChanged(fAuth, (user) => {
      if (user) { setUserId(user.uid); setIsAuthReady(true); }
      else setIsAuthReady(true);
    });
  }, []);
  useEffect(() => {
    if (!db || !userId || permissionError) return;
    const basePath = `/artifacts/${appId}/public/data`;
    const handleError = (err) => {
      if (err.code === 'permission-denied') setPermissionError(true);
    };
    getDocs(collection(db, `${basePath}/houses`)).then(snap => {
      if(snap.empty) {
        const batch = writeBatch(db);
        const studentsRef = collection(db, `${basePath}/students`);
        [...INITIAL_USERS, ...HOUSE_SEED_DATA.map(h => ({...h, total_points: 0})), ...RUBRIC_SEED_DATA, ...CLASS_NAMES.map(n => ({class_name: n}))]
          .forEach(item => {
            let ref, docId;
            if(item.email){ref=collection(db, `${basePath}/users`); docId=item.email.replace(/[^a-zA-Z0-9]/g, '_');}
            else if(item.name && item.motto){ref=collection(db, `${basePath}/houses`);docId=item.name;item={...item, total_points:0};}
            else if(item.class_name){ref=collection(db, `${basePath}/classes`); docId=item.class_name;}
            else if(item.action){ref=collection(db, `${basePath}/rubric`); docId=item.action.replace(/[^a-zA-Z0-9]/g, '_');}
            if(ref) batch.set(doc(ref, docId), item);
          });
        FULL_STUDENT_DATA.forEach(s => {
          const safeId = `${s.name.replace(/[^a-zA-Z0-9]/g, '')}_${s.class_name.replace(/[^a-zA-Z0-9]/g, '')}`;
          batch.set(doc(studentsRef, safeId), { ...s, current_points: 0, id: safeId });
        });
        batch.commit();
      }
    }).catch(e => { if (e.code === 'permission-denied') setPermissionError(true); });
    const unsubH = onSnapshot(collection(db, `${basePath}/houses`), s => setHouses(s.docs.map(d => ({id:d.id,...d.data()}))), handleError);
    const unsubR = onSnapshot(collection(db, `${basePath}/rubric`), s => setRubric(s.docs.map(d => ({id:d.id,...d.data()}))), handleError);
    const unsubS = onSnapshot(collection(db, `${basePath}/students`), s => setAllStudents(s.docs.map(d => ({id:d.id,...d.data()}))), handleError);
    const unsubT = onSnapshot(query(collection(db, `${basePath}/transactions`), orderBy('timestamp', 'desc'), limit(50)), s => setTransactions(s.docs.map(d => ({id:d.id,...d.data()}))), handleError);
    let unsubU = ()=>{};
    if(isAdmin) unsubU = onSnapshot(collection(db, `${basePath}/users`), s => setUsersList(s.docs.map(d => ({id:d.id,...d.data()}))), handleError);
    return () => {unsubH();unsubR();unsubS();unsubT();unsubU();};
  }, [db,userId,isAdmin,permissionError]);
  const handleLogout = () => {setIsStaff(false);setIsAdmin(false);setUserName('');setActiveView('leaderboard');};
  if(permissionError){
    return e('div',{className:"flex items-center justify-center min-h-screen bg-red-50 p-4"},
      e('div',{className:"max-w-md glass p-8 rounded-xl shadow-lg border border-red-200 text-center"},
        e('div',{className:"text-red-500 mb-4 mx-auto w-12 h-12"},e(Icons.Lock)),
        e('h2',{className:"text-2xl font-bold text-red-700 mb-2"},"Permission Denied"),
        e('p',{className:"text-gray-600 mb-4"},"Your Firebase Security Rules are blocking access."),
        e('p',{className:"font-bold text-sm text-gray-800 mt-4"},"Action:"),
        e('ol',{className:"text-sm text-gray-700 list-decimal list-inside text-left mx-auto max-w-xs"},
          e('li',null,"Go to Firebase Console > Firestore Database > Rules."),
          e('li',null,"Publish the following rules (Test Mode) to unblock the app:")
        ),
        e('div',{className:"bg-gray-800 p-3 rounded text-white text-xs font-mono mb-4 mt-2 whitespace-pre-wrap text-left"},"rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}")
      )
    );
  }
  if(!isAuthReady) return e('div',{className:"flex items-center justify-center h-screen text-gray-500 text-xl"},"Loading . . .");
  return (
    e('div',{className:"min-h-screen pb-20"},
      e('div',{className:"dashboard-head flex flex-col md:flex-row justify-between items-center p-4 border-b shadow-sm mb-2"},
        e('h1',{className:"font-bold text-3xl text-glow"}, "ðŸ  House System Tracker"),
        e('div',{className:"flex gap-2 mt-2 md:mt-0"},
          e('button',{onClick:()=>setActiveView('entry'),className:`glassy-btn px-4 py-1 text-sm ${activeView==='entry'?'shadow-lg scale-105 ring-2 ring-cyan-200':''}`}, "Entry"),
          e('button',{onClick:()=>setActiveView('leaderboard'),className:`glassy-btn px-4 py-1 text-sm ${activeView==='leaderboard'?'shadow-lg scale-105 ring-2 ring-yellow-200':''}`},"Leaderboard"),
          isAdmin && e('button',{onClick:()=>setActiveView('admin'),className:`glassy-btn px-4 py-1 text-sm ${activeView==='admin'?'shadow-lg scale-105 ring-2 ring-indigo-200':''}`}, "Admin"),
          isStaff && e('button',{onClick:handleLogout,className:"glassy-btn px-4 py-1 text-sm bg-red-200 text-red-700 hover:bg-red-300"},"Logout")
        )
      ),
      activeView==='leaderboard' && e(HouseLeaderboard, {houses: houses}),
      activeView==='admin' && e(AdminView, {db, appId, transactions, usersList, houses}),
      activeView==='entry' && (isStaff ? e(EntryView, {allStudents, rubric, db, appId, userName}) : e(Login, {db, appId, setIsStaff, setUserName, setIsAdmin, setActiveView}))
    )
  );
};
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(e(App));
</script>
</body>
</html>
