<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>House System — Professional Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>

  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.2/dist/Recharts.min.js"></script>

  <style>
    /* --- Theming & Variables --- */
    :root {
      --bg-dark: #020617; /* Slate 950 */
      --glass-bg: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.1);
      --primary-grad: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
      --accent-glow: 0 0 20px rgba(168, 85, 247, 0.3);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
    }

    body {
      margin: 0;
      font-family: 'Outfit', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* --- Animated Background Particles --- */
    .bg-animation {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    .blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.4;
      animation: float 20s infinite alternate;
    }
    .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #4f46e5; animation-delay: 0s; }
    .blob-2 { bottom: -10%; right: -10%; width: 600px; height: 600px; background: #db2777; animation-delay: -5s; }
    .blob-3 { top: 40%; left: 40%; width: 400px; height: 400px; background: #7c3aed; animation-delay: -10s; }

    @keyframes float {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(30px, 50px) scale(1.1); }
    }

    /* --- Glassmorphism Components --- */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s;
    }
    .glass-panel:hover {
      border-color: var(--glass-highlight);
    }

    .glass-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border);
      color: white;
      transition: all 0.2s;
    }
    .glass-btn:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .glass-btn-primary {
      background: var(--primary-grad);
      border: none;
      box-shadow: var(--accent-glow);
    }
    .glass-btn-primary:hover {
      opacity: 0.9;
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
    }

    .glass-input {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--glass-border);
      color: white;
      transition: all 0.2s;
    }
    .glass-input:focus {
      outline: none;
      border-color: #a855f7;
      box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
    }

    /* --- Utilities --- */
    .text-gradient {
      background: var(--primary-grad);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
    }
    
    .anim-enter { animation: fadeUp 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
    .anim-delay-1 { animation-delay: 0.1s; }
    .anim-delay-2 { animation-delay: 0.2s; }
    .anim-delay-3 { animation-delay: 0.3s; }

    @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
  </style>
</head>
<body>
  
  <div class="bg-animation">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <div id="root"></div>

<script type="module">
/* eslint-disable no-unused-vars */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import {
  getAuth, signInAnonymously, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import {
  getFirestore, collection, doc, setDoc, getDocs, onSnapshot, query, orderBy, limit, writeBatch, runTransaction, increment, deleteDoc
} from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyC1rWI1b87xeqHJtYmsRUL8Ruf33nJiQIM",
  authDomain: "house-system-f54a3.firebaseapp.com",
  projectId: "house-system-f54a3",
  storageBucket: "house-system-f54a3.appspot.com",
  messagingSenderId: "171645573652",
  appId: "1:171645573652:web:9942711f898071a66ba501"
};

const appId = 'house-system-v1';
const { useState, useEffect, useMemo } = React;
const e = React.createElement;
const RC = window.Recharts || {};

/* --- ICONS (SVG) --- */
const Icons = {
  Home: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:20,height:20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('path',{d:"m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"}),e('polyline',{points:"9 22 9 12 15 12 15 22"})),
  PlusCircle: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:20,height:20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('circle',{cx:12,cy:12,r:10}),e('path',{d:"M12 8v8"}),e('path',{d:"M8 12h8"})),
  Shield: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:20,height:20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('path',{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" })),
  LogOut: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:18,height:18,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('path',{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1-2-2h4"}),e('polyline',{points:"16 17 21 12 16 7"}),e('line',{x1:21,x2:9,y1:12,y2:12})),
  User: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:18,height:18,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('path',{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"}),e('circle',{cx:12,cy:7,r:4})),
  TrendingUp: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:20,height:20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('polyline',{points:"22 7 13.5 15.5 8.5 10.5 2 17"}),e('polyline',{points:"16 7 22 7 22 13"})),
  Trophy: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:20,height:20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"},e('path',{d:"M6 9H4.5a2.5 2.5 0 0 1 0-5H6"}),e('path',{d:"M18 9h1.5a2.5 2.5 0 0 0 0-5H18"}),e('path',{d:"M4 22h16"}),e('path',{d:"M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"}),e('path',{d:"M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"}),e('path',{d:"M18 2H6v7a6 6 0 0 0 12 0V2Z"}))
};

// --- DATA CONSTANTS ---
const HOUSE_SEED_DATA = [
  { name: 'Rihno', color: '#10b981', motto: "Strength in Unity" },
  { name: 'Cougar', color: '#3b82f6', motto: "Courage and Grace" },
  { name: 'Eagles', color: '#f59e0b', motto: "Soaring to Success" },
  { name: 'Oraca', color: '#ef4444', motto: "Passion and Precision" }
];
// (Using same RUBRIC and STUDENTS as V1, abbreviated here for length, but logic ensures they load)
const RUBRIC_SEED_DATA = [
  { category: 'Academic', action: 'High test scores', points: 15, is_miss_out: false },
  { category: 'Behavior', action: 'Compassion: Act of kindness', points: 30, is_miss_out: false },
  { category: 'Behavior', action: 'Respect: Show respect', points: 30, is_miss_out: false },
  { category: 'Events', action: 'Winning a competition', points: 20, is_miss_out: false },
  { category: 'Miss-Out', action: 'Misbehavior', points: -10, is_miss_out: true }
];
const INITIAL_USERS = [
  { email: "teacher@school.edu", password: "password123", role: "staff", name: "Default Teacher" },
  { email: "admin@school.edu", password: "admin123", role: "admin", name: "System Admin" }
];
const FULL_STUDENT_DATA = [
  {"name":"Yaseen Aseem Saady","class_name":"Grade 10","house_id":"Eagles"},
  {"name":"Abdelrahman Bahaa","class_name":"Grade 10","house_id":"Cougar"},
  {"name":"Karma Mahmoud","class_name":"Grade 9","house_id":"Eagles"},
  {"name":"Reem Hossam","class_name":"Grade 9","house_id":"Oraca"},
  {"name":"Retal Mohamed","class_name":"Grade 8","house_id":"Rihno"},
  {"name":"Adam Ahmed","class_name":"Grade 8","house_id":"Cougar"},
  {"name":"Laila Mahmoud","class_name":"Grade 7","house_id":"Cougar"},
  {"name":"Lamis Ahmed","class_name":"Grade 7","house_id":"Rihno"},
  {"name":"Sara Mohamed","class_name":"Grade 6","house_id":"Rihno"},
  {"name":"Saeed Ahmed","class_name":"Grade 6","house_id":"Cougar"},
  {"name":"Adham Yousry","class_name":"Grade 5","house_id":"Oraca"},
  {"name":"Selim Mohamed","class_name":"Grade 5","house_id":"Oraca"},
  {"name":"Aseel Atef","class_name":"Grade 4","house_id":"Cougar"},
  {"name":"Layan Mohamed","class_name":"Grade 4","house_id":"Cougar"},
  {"name":"Yousef Mohamed","class_name":"Grade 3","house_id":"Cougar"},
  {"name":"Elaf Mohamed","class_name":"Grade 3","house_id":"Eagles"},
  {"name":"Anas Ahmed","class_name":"Y2-B","house_id":"Rihno"},
  {"name":"YOUSSEF MOHAMED","class_name":"Y2-C","house_id":"Eagles"},
  {"name":"Mourad Mohamed","class_name":"Y2-A","house_id":"Cougar"},
  {"name":"Laila Amr","class_name":"Y1-E","house_id":"Oraca"},
  {"name":"Asma Osman","class_name":"Y1-D","house_id":"Rihno"},
  {"name":"Adam Mohammed","class_name":"Y1-C","house_id":"Eagles"},
  {"name":"Ismail Muhammad","class_name":"Y1-B","house_id":"Cougar"},
  {"name":"Raheem Yasser","class_name":"Y1-A","house_id":"Oraca"},
  {"name":"Zain Ahmed","class_name":"Pre.K","house_id":"Eagles"},
  {"name":"Gamila Ramy","class_name":"Pre.K","house_id":"Oraca"},
  {"name":"Hamza Zayed","class_name":"Pre.K","house_id":"Rihno"},
  {"name":"Farah Husam","class_name":"Pre.K","house_id":"Eagles"}
];
const CLASS_NAMES = [...new Set(FULL_STUDENT_DATA.map(s => s.class_name))].sort();


// --- COMPONENTS ---

// 1. STAT CARD
const StatCard = ({ label, value, icon, color, delay }) => {
  return e('div', { className: `glass-panel p-5 flex items-center gap-4 anim-enter ${delay}` },
    e('div', { 
      className: "w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg",
      style: { background: color } 
    }, icon),
    e('div', null,
      e('div', { className: "text-sm text-gray-400 font-medium" }, label),
      e('div', { className: "text-2xl font-bold text-white" }, value)
    )
  );
};

// 2. MAIN DASHBOARD (Updated HouseAnalytics)
const HouseAnalytics = ({ houses = [], transactions = [] }) => {
  // Prep Data
  const totalPoints = houses.reduce((sum, h) => sum + (h.total_points || 0), 0);
  const leadingHouse = [...houses].sort((a,b) => (b.total_points||0) - (a.total_points||0))[0] || {name:'-', total_points:0};
  const recentTxCount = transactions.length;

  // Chart Data
  const barData = (houses || []).map(h => ({ 
    name: h.name, 
    points: h.total_points || 0, 
    color: HOUSE_SEED_DATA.find(x=>x.name===h.name)?.color || '#888' 
  }));
  
  // 14-Day Trend
  const tsMap = {};
  const today = new Date();
  for(let i=13; i>=0; i--) {
    const d = new Date(today); d.setDate(today.getDate()-i);
    tsMap[d.toISOString().slice(0,10)] = 0;
  }
  transactions.forEach(t => {
    const dStr = (t.timestamp || '').slice(0,10);
    if(tsMap[dStr] !== undefined) tsMap[dStr] += (t.points || 0);
  });
  const areaData = Object.keys(tsMap).sort().map(k => ({ date: k, value: tsMap[k] }));

  return e('div', { className: "space-y-6" },
    // Stats Row
    e('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" },
      e(StatCard, { label: "Total Points Awarded", value: totalPoints.toLocaleString(), icon: e(Icons.Trophy), color: "linear-gradient(135deg, #fbbf24, #d97706)", delay: "anim-delay-1" }),
      e(StatCard, { label: "Leading House", value: leadingHouse.name, icon: e(Icons.TrendingUp), color: HOUSE_SEED_DATA.find(x=>x.name===leadingHouse.name)?.color || '#10b981', delay: "anim-delay-1" }),
      e(StatCard, { label: "Transactions Recorded", value: recentTxCount, icon: e(Icons.PlusCircle), color: "linear-gradient(135deg, #3b82f6, #2563eb)", delay: "anim-delay-2" }),
      e(StatCard, { label: "Active Houses", value: houses.length, icon: e(Icons.Home), color: "linear-gradient(135deg, #8b5cf6, #7c3aed)", delay: "anim-delay-2" })
    ),

    // Main Charts
    e('div', { className: "grid grid-cols-1 lg:grid-cols-12 gap-6" },
      // Bar Chart
      e('div', { className: "glass-panel p-6 lg:col-span-8 anim-enter anim-delay-3" },
        e('h3', { className: "text-lg font-bold mb-1" }, "House Performance"),
        e('p', { className: "text-sm text-gray-500 mb-6" }, "Current point standings"),
        e(RC.ResponsiveContainer, { width: "100%", height: 300 },
          e(RC.BarChart, { data: barData },
            e(RC.CartesianGrid, { strokeDasharray: "3 3", stroke: "rgba(255,255,255,0.05)", vertical: false }),
            e(RC.XAxis, { dataKey: "name", tick: {fill: '#94a3b8'}, axisLine: false, tickLine: false }),
            e(RC.YAxis, { tick: {fill: '#94a3b8'}, axisLine: false, tickLine: false }),
            e(RC.Tooltip, { 
              contentStyle: { backgroundColor: 'rgba(15, 23, 42, 0.9)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff' },
              cursor: { fill: 'rgba(255,255,255,0.05)' } 
            }),
            e(RC.Bar, { dataKey: "points", radius: [8,8,0,0] },
              barData.map((entry, index) => (
                e(RC.Cell, { key: `cell-${index}`, fill: entry.color })
              ))
            )
          )
        )
      ),
      // Donut Chart
      e('div', { className: "glass-panel p-6 lg:col-span-4 anim-enter anim-delay-3 flex flex-col" },
        e('h3', { className: "text-lg font-bold mb-1" }, "Distribution"),
        e('p', { className: "text-sm text-gray-500 mb-4" }, "Share of total points"),
        e('div', { className: "flex-1 min-h-[250px]" },
          e(RC.ResponsiveContainer, { width: "100%", height: "100%" },
            e(RC.PieChart, null,
              e(RC.Pie, { 
                data: barData, innerRadius: 60, outerRadius: 85, paddingAngle: 5, dataKey: "points" 
              }, barData.map((entry, index) => e(RC.Cell, { key: `pie-${index}`, fill: entry.color, stroke: 'none' }))),
              e(RC.Tooltip, { contentStyle: { backgroundColor: 'rgba(15, 23, 42, 0.9)', borderRadius: '8px', border:'none' } }),
              e(RC.Legend, { verticalAlign: "bottom", height: 36, iconType: "circle" })
            )
          )
        )
      )
    ),

    // Trend Area Chart
    e('div', { className: "glass-panel p-6 anim-enter anim-delay-3" },
      e('h3', { className: "text-lg font-bold mb-1" }, "Activity Trend"),
      e('p', { className: "text-sm text-gray-500 mb-4" }, "Points awarded over the last 14 days"),
      e(RC.ResponsiveContainer, { width: "100%", height: 200 },
        e(RC.AreaChart, { data: areaData },
          e('defs', null,
            e('linearGradient', { id: "colorPv", x1: "0", y1: "0", x2: "0", y2: "1" },
              e('stop', { offset: "5%", stopColor: "#8b5cf6", stopOpacity: 0.5 }),
              e('stop', { offset: "95%", stopColor: "#8b5cf6", stopOpacity: 0 })
            )
          ),
          e(RC.CartesianGrid, { strokeDasharray: "3 3", stroke: "rgba(255,255,255,0.05)", vertical:false }),
          e(RC.XAxis, { dataKey: "date", hide: true }),
          e(RC.Tooltip, { contentStyle: { backgroundColor: '#0f172a', border: 'none', borderRadius:'8px' } }),
          e(RC.Area, { type: "monotone", dataKey: "value", stroke: "#8b5cf6", strokeWidth: 3, fillOpacity: 1, fill: "url(#colorPv)" })
        )
      )
    )
  );
};

// 3. ENTRY VIEW (Updated)
const EntryView = ({ allStudents, rubric, db, appId, userName }) => {
  const [selectedClass, setSelectedClass] = useState(CLASS_NAMES[0]);
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [search, setSearch] = useState('');
  const [msg, setMsg] = useState('');
  const [loading, setLoading] = useState(false);

  // Filter Logic
  const filteredStudents = useMemo(() => {
    let list = allStudents.filter(s => s.class_name === selectedClass);
    if(search) list = list.filter(s => s.name.toLowerCase().includes(search.toLowerCase()));
    return list.sort((a,b)=>a.name.localeCompare(b.name));
  }, [allStudents, selectedClass, search]);

  const handleAward = async (item) => {
    if (!selectedStudent || loading) return;
    setLoading(true);
    try {
      const fs = getFirestore();
      const batch = writeBatch(fs); // Using batch for cleaner one-go feel
      // In a real robust app use transaction, but for UI demo batch is fine. 
      // Keeping transaction logic from V1 below inside runTransaction for safety.
      await runTransaction(fs, async (t) => {
        const sRef = doc(fs, `/artifacts/${appId}/public/data/students`, selectedStudent.id);
        const hRef = doc(fs, `/artifacts/${appId}/public/data/houses`, selectedStudent.house_id);
        const newTxRef = doc(collection(fs, `/artifacts/${appId}/public/data/transactions`));
        
        t.update(sRef, { current_points: increment(item.points) });
        t.update(hRef, { total_points: increment(item.points) });
        t.set(newTxRef, {
          action: item.action, points: item.points, category: item.category,
          timestamp: new Date().toISOString(), awardedBy: userName,
          studentName: selectedStudent.name, houseId: selectedStudent.house_id
        });
      });

      setMsg(`Awarded ${item.points} to ${selectedStudent.name}`);
      setTimeout(()=>setMsg(''), 3000);
      setSelectedStudent(null); 
    } catch(e) { console.error(e); setMsg("Error updating points"); }
    setLoading(false);
  };

  return e('div', { className: "max-w-7xl mx-auto space-y-6" },
    // Header
    e('div', { className: "flex justify-between items-end" },
      e('div', null,
        e('h2', { className: "text-3xl font-bold text-white tracking-tight" }, "Point Entry"),
        e('p', { className: "text-gray-400 mt-1" }, "Award points for achievements or behavior.")
      ),
      msg && e('div', { className: "px-4 py-2 bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 rounded-lg text-sm font-bold animate-pulse" }, msg)
    ),

    e('div', { className: "grid grid-cols-1 lg:grid-cols-12 gap-6" },
      // Left: Selector
      e('div', { className: "lg:col-span-4 glass-panel p-6 flex flex-col h-[600px]" },
        e('div', { className: "mb-4 space-y-3" },
          e('label', { className: "text-xs font-bold uppercase text-gray-500 tracking-wider" }, "Select Class"),
          e('select', { 
            className: "glass-input w-full p-3 rounded-xl",
            value: selectedClass, onChange: e=>{setSelectedClass(e.target.value); setSelectedStudent(null);} 
          }, CLASS_NAMES.map(c => e('option', { key:c, value:c, className: "bg-slate-900" }, c))),
          e('input', { 
            className: "glass-input w-full p-3 rounded-xl", 
            placeholder: "Search student...", value: search, onChange: e=>setSearch(e.target.value) 
          })
        ),
        e('div', { className: "flex-1 overflow-y-auto space-y-2 pr-1" },
          filteredStudents.map(s => {
            const hColor = HOUSE_SEED_DATA.find(h=>h.name===s.house_id)?.color || '#666';
            const isSel = selectedStudent?.id === s.id;
            return e('div', {
              key: s.id, onClick: ()=>setSelectedStudent(s),
              className: `p-3 rounded-xl cursor-pointer border transition-all flex justify-between items-center group ${isSel ? 'bg-purple-600/20 border-purple-500/50' : 'bg-white/5 border-transparent hover:bg-white/10'}`,
            }, 
              e('div', null,
                e('div', { className: `font-bold ${isSel?'text-white':'text-gray-300 group-hover:text-white'}` }, s.name),
                e('div', { className: "text-xs text-gray-500 flex items-center gap-2" }, 
                  e('span', { className: "w-2 h-2 rounded-full", style:{background:hColor}}),
                  s.house_id
                )
              ),
              e('div', { className: "font-mono font-bold text-gray-400" }, s.current_points)
            );
          })
        )
      ),
      
      // Right: Rubric
      e('div', { className: "lg:col-span-8 glass-panel p-6" },
        !selectedStudent ? 
          e('div', { className: "h-full flex flex-col items-center justify-center text-gray-500 opacity-60" },
            e(Icons.User), e('span', { className: "mt-2" }, "Select a student to begin")
          ) :
          e('div', null,
            e('div', { className: "mb-6 pb-6 border-b border-white/10 flex justify-between items-center" },
              e('div', null,
                e('div', { className: "text-sm text-gray-400" }, "Awarding to"),
                e('div', { className: "text-2xl font-bold text-white" }, selectedStudent.name)
              ),
              e('div', { className: "px-4 py-1 rounded-full bg-white/5 border border-white/10 text-sm" }, selectedStudent.class_name)
            ),
            e('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
              RUBRIC_SEED_DATA.map(r => {
                const isNeg = r.is_miss_out;
                return e('button', {
                  key: r.action, onClick: ()=>handleAward(r), disabled: loading,
                  className: `relative overflow-hidden p-4 rounded-xl border text-left transition-all hover:scale-[1.02] active:scale-[0.98] ${isNeg ? 'bg-red-500/5 border-red-500/20 hover:bg-red-500/10' : 'bg-emerald-500/5 border-emerald-500/20 hover:bg-emerald-500/10'}`
                },
                  e('div', { className: "flex justify-between items-start mb-2" },
                    e('span', { className: `text-xs font-bold uppercase tracking-wider px-2 py-1 rounded ${isNeg ? 'bg-red-500/20 text-red-300':'bg-emerald-500/20 text-emerald-300'}` }, r.category),
                    e('span', { className: `text-xl font-bold font-mono ${isNeg?'text-red-400':'text-emerald-400'}` }, isNeg ? r.points : `+${r.points}`)
                  ),
                  e('div', { className: "font-bold text-white" }, r.action)
                );
              })
            )
          )
      )
    )
  );
};

// 4. ADMIN VIEW (Simplified for V3)
const AdminView = ({ transactions, usersList }) => {
  return e('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-6" },
    e('div', { className: "glass-panel p-6 lg:col-span-1" },
      e('h3', { className: "text-lg font-bold mb-4" }, "Registered Users"),
      e('div', { className: "space-y-3" },
        (usersList||[]).map(u => e('div', { key:u.email, className: "p-3 bg-white/5 rounded-lg border border-white/5 flex justify-between items-center" },
          e('div', null, 
            e('div', { className: "font-bold text-sm" }, u.name || 'User'),
            e('div', { className: "text-xs text-gray-500" }, u.email)
          ),
          e('span', { className: "text-xs bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded" }, u.role)
        ))
      )
    ),
    e('div', { className: "glass-panel p-6 lg:col-span-2" },
      e('h3', { className: "text-lg font-bold mb-4" }, "Recent Audit Log"),
      e('div', { className: "overflow-y-auto max-h-[500px] space-y-2 pr-2" },
        (transactions||[]).map(t => e('div', { key: t.id, className: "flex justify-between items-center p-3 rounded-lg hover:bg-white/5 border-b border-white/5 last:border-0" },
          e('div', null,
            e('div', { className: "font-bold text-sm text-gray-200" }, t.studentName),
            e('div', { className: "text-xs text-gray-500" }, `${t.action} • by ${t.awardedBy || 'System'}`)
          ),
          e('div', { className: `font-mono font-bold ${t.points > 0 ? 'text-emerald-400' : 'text-red-400'}` }, 
            t.points > 0 ? `+${t.points}` : t.points
          )
        ))
      )
    )
  );
};

// 5. LOGIN
const Login = ({ db, appId, setIsStaff, setUserName, setIsAdmin, setActiveView }) => {
  const [email, setEmail] = useState('');
  const [pass, setPass] = useState('');
  const [err, setErr] = useState('');

  const handleLogin = async (e) => {
    e.preventDefault();
    try {
      const q = query(collection(db, `/artifacts/${appId}/public/data/users`));
      const snap = await getDocs(q);
      const user = snap.docs.map(d=>d.data()).find(u => u.email === email && u.password === pass);
      if(user) {
        setIsStaff(true); setIsAdmin(user.role==='admin'); setUserName(user.name); setActiveView(user.role==='admin'?'admin':'entry');
      } else setErr("Invalid Credentials");
    } catch(err) { console.error(err); setErr("Login Failed"); }
  };
  
  // Google Sign In
  const handleGoogle = async () => {
    try {
      const auth = getAuth();
      const res = await signInWithPopup(auth, new GoogleAuthProvider());
      // Check if email exists in users collection
      const snap = await getDocs(collection(db, `/artifacts/${appId}/public/data/users`));
      const user = snap.docs.map(d=>d.data()).find(u => u.email === res.user.email);
      if(user) {
        setIsStaff(true); setIsAdmin(user.role==='admin'); setUserName(user.name); setActiveView(user.role==='admin'?'admin':'entry');
      } else {
        setErr("Account not authorized.");
        signOut(auth);
      }
    } catch(e) { setErr(e.message); }
  };

  return e('div', { className: "min-h-screen flex items-center justify-center p-4 relative z-10" },
    e('div', { className: "glass-panel p-8 w-full max-w-md anim-enter" },
      e('div', { className: "text-center mb-8" },
        e('div', { className: "w-16 h-16 bg-gradient-to-br from-indigo-500 to-pink-500 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-xl shadow-purple-500/30" },
          e('span', { className: "text-2xl font-bold text-white" }, "HS")
        ),
        e('h1', { className: "text-2xl font-bold text-white" }, "Staff Access"),
        e('p', { className: "text-sm text-gray-400" }, "House System Dashboard")
      ),
      err && e('div', { className: "bg-red-500/10 text-red-400 text-sm p-3 rounded mb-4 text-center border border-red-500/20" }, err),
      e('form', { onSubmit: handleLogin, className: "space-y-4" },
        e('div', null,
          e('label', { className: "text-xs text-gray-500 uppercase font-bold ml-1" }, "Email"),
          e('input', { className: "glass-input w-full p-3 rounded-lg mt-1", value: email, onChange: e=>setEmail(e.target.value), placeholder: "teacher@school.edu" })
        ),
        e('div', null,
          e('label', { className: "text-xs text-gray-500 uppercase font-bold ml-1" }, "Password"),
          e('input', { type: "password", className: "glass-input w-full p-3 rounded-lg mt-1", value: pass, onChange: e=>setPass(e.target.value), placeholder: "••••••••" })
        ),
        e('button', { className: "glass-btn glass-btn-primary w-full py-3 rounded-lg font-bold text-lg" }, "Sign In"),
        e('div', { className: "relative py-2" },
          e('div', { className: "absolute inset-0 flex items-center" }, e('div', { className: "w-full border-t border-white/10" })),
          e('div', { className: "relative flex justify-center" }, e('span', { className: "bg-[#080c18] px-2 text-xs text-gray-500" }, "OR"))
        ),
        e('button', { type: 'button', onClick: handleGoogle, className: "glass-btn w-full py-3 rounded-lg font-bold flex items-center justify-center gap-2" },
          e('span', null, "Sign in with Google")
        )
      ),
      e('div', { className: "mt-6 text-center" },
        e('p', { className: "text-xs text-gray-600" }, "Demo: teacher@school.edu / password123")
      )
    )
  );
};

// 6. MAIN APP SHELL
const App = () => {
  const [db, setDb] = useState(null);
  const [isReady, setIsReady] = useState(false);
  
  // State
  const [isStaff, setIsStaff] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);
  const [userName, setUserName] = useState('');
  const [view, setView] = useState('leaderboard');

  // Data
  const [houses, setHouses] = useState([]);
  const [rubric, setRubric] = useState([]);
  const [students, setStudents] = useState([]);
  const [txs, setTxs] = useState([]);
  const [users, setUsers] = useState([]);

  // Init Firebase
  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const fs = getFirestore(app);
    setDb(fs);
    const auth = getAuth(app);
    signInAnonymously(auth).then(()=>setIsReady(true)).catch(e=>console.error(e));
  }, []);

  // Sync Data
  useEffect(() => {
    if(!db) return;
    const bp = `/artifacts/${appId}/public/data`;
    
    // Auto-seed check (preserving original logic mostly)
    const seed = async () => {
      const snap = await getDocs(collection(db, `${bp}/houses`));
      if(snap.empty) {
        const batch = writeBatch(db);
        HOUSE_SEED_DATA.forEach(h => batch.set(doc(db, `${bp}/houses`, h.name), { ...h, total_points: 0 }));
        RUBRIC_SEED_DATA.forEach(r => batch.set(doc(db, `${bp}/rubric`, r.action.replace(/\W/g,'')), r));
        INITIAL_USERS.forEach(u => batch.set(doc(db, `${bp}/users`, u.email.replace(/\W/g,'')), u));
        FULL_STUDENT_DATA.forEach(s => {
          const id = (s.name+s.class_name).replace(/[^a-zA-Z0-9]/g,'');
          batch.set(doc(db, `${bp}/students`, id), { ...s, current_points: 0, id });
        });
        await batch.commit();
      }
    };
    seed();

    const unH = onSnapshot(collection(db, `${bp}/houses`), s=>setHouses(s.docs.map(d=>({id:d.id,...d.data()}))));
    const unS = onSnapshot(collection(db, `${bp}/students`), s=>setStudents(s.docs.map(d=>({id:d.id,...d.data()}))));
    const unT = onSnapshot(query(collection(db, `${bp}/transactions`), orderBy('timestamp','desc'), limit(100)), s=>setTxs(s.docs.map(d=>({id:d.id,...d.data()}))));
    
    let unU = ()=>{};
    if(isAdmin) unU = onSnapshot(collection(db, `${bp}/users`), s=>setUsers(s.docs.map(d=>({id:d.id,...d.data()}))));

    return () => { unH(); unS(); unT(); unU(); };
  }, [db, isAdmin]);

  if(!isReady) return e('div', {className:"h-screen flex items-center justify-center text-white"}, "Initializing Quantum Core...");

  // Navigation Component
  const Nav = () => e('nav', { className: "sticky top-0 z-50 glass-panel rounded-none border-x-0 border-t-0 mb-8" },
    e('div', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" },
      e('div', { className: "flex items-center justify-between h-16" },
        e('div', { className: "flex items-center gap-3" },
          e('div', { className: "w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-white shadow-lg shadow-indigo-500/50" }, "H"),
          e('span', { className: "text-lg font-bold tracking-tight text-white hidden sm:block" }, "House System")
        ),
        e('div', { className: "flex items-center gap-2" },
          e('button', { onClick: ()=>setView('leaderboard'), className: `px-4 py-2 rounded-lg text-sm font-medium transition-all ${view==='leaderboard' ? 'bg-white/10 text-white shadow-inner' : 'text-gray-400 hover:text-white hover:bg-white/5'}` }, "Dashboard"),
          e('button', { onClick: ()=>setView('entry'), className: `px-4 py-2 rounded-lg text-sm font-medium transition-all ${view==='entry' ? 'bg-white/10 text-white shadow-inner' : 'text-gray-400 hover:text-white hover:bg-white/5'}` }, "Entry"),
          isAdmin && e('button', { onClick: ()=>setView('admin'), className: `px-4 py-2 rounded-lg text-sm font-medium transition-all ${view==='admin' ? 'bg-white/10 text-white shadow-inner' : 'text-gray-400 hover:text-white hover:bg-white/5'}` }, "Admin"),
          isStaff && e('button', { onClick: ()=>{setIsStaff(false);setIsAdmin(false);setView('leaderboard');}, className: "ml-2 p-2 text-gray-400 hover:text-red-400 transition-colors" }, e(Icons.LogOut))
        )
      )
    )
  );

  return e('div', { className: "min-h-screen pb-10 relative z-10" },
    e(Nav),
    e('main', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" },
      view === 'leaderboard' && e(HouseAnalytics, { houses, transactions: txs }),
      view === 'entry' && (isStaff ? e(EntryView, { allStudents: students, rubric, db, appId, userName }) : e(Login, { db, appId, setIsStaff, setIsAdmin, setUserName, setActiveView: setView })),
      view === 'admin' && (isAdmin ? e(AdminView, { transactions: txs, usersList: users }) : e('div', { className: "text-center mt-20 text-gray-500" }, "Access Restricted"))
    )
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(e(App));
</script>
</body>
</html>
