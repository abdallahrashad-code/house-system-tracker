<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House System Tracker</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Recharts -->
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.2/dist/Recharts.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
<div id="root"></div>
<!-- Firebase and Logic -->
<script type="module">
// Firebase is loaded from CDN via ES Module import
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getFirestore, doc, onSnapshot, collection, query, updateDoc, increment, setDoc, getDocs, runTransaction, where, orderBy, limit, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

const appId = "house-system-v1";
const firebaseConfig = {
  apiKey: "AIzaSyC1rWI1b87xeqHJtYmsRUL8Ruf33nJiQIM",
  authDomain: "house-system-f54a3.firebaseapp.com",
  projectId: "house-system-f54a3",
  storageBucket: "house-system-f54a3.appspot.com",
  messagingSenderId: "171645573652",
  appId: "1:171645573652:web:9942711f898071a66ba501"
};

// --- React shortcuts ---
const { useState, useEffect, useCallback, useMemo } = React;
const e = React.createElement;

// --- Sample Data ---
const INITIAL_USERS = [
  { email: "teacher@school.edu", password: "password123", role: "staff", name: "Default Teacher" },
  { email: "admin@school.edu", password: "admin123", role: "admin", name: "System Admin" }
];
const HOUSE_SEED_DATA = [
  { name: 'Rihno', color: '#10b981', motto: "Strength in Unity" },
  { name: 'Cougar', color: '#3b82f6', motto: "Courage and Grace" },
  { name: 'Eagles', color: '#f59e0b', motto: "Soaring to Success" },
  { name: 'Oraca', color: '#ef4444', motto: "Passion and Precision" }
];
const RUBRIC_SEED_DATA = [
  { category: 'Academic', action: 'High test scores', points: 15, is_miss_out: false },
  { category: 'Behavior', action: 'Compassion: Act of kindness', points: 30, is_miss_out: false },
  { category: 'Behavior', action: 'Respect: Show respect & Good Manners', points: 30, is_miss_out: false },
  { category: 'Events', action: 'Winning a school competition', points: 20, is_miss_out: false },
  { category: 'Miss-Out', action: 'Misbehavior in events', points: -10, is_miss_out: true }
];
const FULL_STUDENT_DATA = [
  {"name": "Yaseen Aseem Saady", "class_name": "Grade 10", "house_id": "Eagles"},
  {"name": "Abdelrahman Bahaa", "class_name": "Grade 10", "house_id": "Cougar"},
  {"name": "Karma Mahmoud", "class_name": "Grade 9", "house_id": "Eagles"},
  {"name": "Reem Hossam", "class_name": "Grade 9", "house_id": "Oraca"},
  {"name": "Retal Mohamed", "class_name": "Grade 8", "house_id": "Rihno"},
  {"name": "Adam Ahmed", "class_name": "Grade 8", "house_id": "Cougar"},
  {"name": "Laila Mahmoud", "class_name": "Grade 7", "house_id": "Cougar"},
  {"name": "Lamis Ahmed", "class_name": "Grade 7", "house_id": "Rihno"},
  {"name": "Sara Mohamed", "class_name": "Grade 6", "house_id": "Rihno"},
  {"name": "Saeed Ahmed", "class_name": "Grade 6", "house_id": "Cougar"},
  {"name": "Adham Yousry", "class_name": "Grade 5", "house_id": "Oraca"},
  {"name": "Selim Mohamed", "class_name": "Grade 5", "house_id": "Oraca"},
  {"name": "Aseel Atef", "class_name": "Grade 4", "house_id": "Cougar"},
  {"name": "Layan Mohamed", "class_name": "Grade 4", "house_id": "Cougar"},
  {"name": "Yousef Mohamed", "class_name": "Grade 3", "house_id": "Cougar"},
  {"name": "Elaf Mohamed", "class_name": "Grade 3", "house_id": "Eagles"},
  {"name": "Anas Ahmed", "class_name": "Y2-B", "house_id": "Rihno"},
  {"name": "YOUSSEF MOHAMED", "class_name": "Y2-C", "house_id": "Eagles"},
  {"name": "Mourad Mohamed", "class_name": "Y2-A", "house_id": "Cougar"},
  {"name": "Laila Amr", "class_name": "Y1-E", "house_id": "Oraca"},
  {"name": "Asma Osman", "class_name": "Y1-D", "house_id": "Rihno"},
  {"name": "Adam Mohammed", "class_name": "Y1-C", "house_id": "Eagles"},
  {"name": "Ismail Muhammad", "class_name": "Y1-B", "house_id": "Cougar"},
  {"name": "Raheem Yasser", "class_name": "Y1-A", "house_id": "Oraca"},
  {"name": "Zain Ahmed", "class_name": "Pre.K", "house_id": "Eagles"},
  {"name": "Gamila Ramy", "class_name": "Pre.K", "house_id": "Oraca"},
  {"name": "Hamza Zayed", "class_name": "Pre.K", "house_id": "Rihno"},
  {"name": "Farah Husam", "class_name": "Pre.K", "house_id": "Eagles"}
];
const CLASS_NAMES = [...new Set(FULL_STUDENT_DATA.map(s => s.class_name))].sort();

// Icons
const Icons = {
    Star: ({ className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", fill: "none", stroke: "#fbbf24", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, e('polygon', { points: "12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" })),
    Clipboard: () => e('svg', {xmlns:"http://www.w3.org/2000/svg",fill:"none",stroke:"currentColor",width:"24",height:"24",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},e('rect',{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1"}),e('path',{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}),e('path',{d:"M12 11h4"}),e('path',{d:"M12 16h4"}),e('path',{d:"M8 11h.01"}),e('path',{d:"M8 16h.01"})),
    Lock: () => e('svg',{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",fill:"none",stroke:"red",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},e('rect',{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2"}),e('path',{d:"M7 11V7a5 5 0 0 1 10 0v4"})),
    Trash2: () => e('svg', {xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},e('path',{d:"M3 6h18"}),e('path',{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e('path',{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}),e('line',{x1:"10",x2:"10",y1:"11",y2:"17"}),e('line',{x1:"14",x2:"14",y1:"11",y2:"17"}))
};

// COMPONENTS

const HouseLeaderboard = ({ houses }) => {
    const RC = window.Recharts;
    if (!RC || !RC.BarChart) return e('div', {className: "p-6 text-center"}, "Loading Charts...");
    const chartData = houses.map(h => ({ 
        name: h.name, 
        Points: h.total_points, 
        fill: HOUSE_SEED_DATA.find(s => s.name === h.name)?.color || '#888' 
    }));
    return e('div', {className: "p-6 max-w-6xl mx-auto"},
        e('div', {className: "grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"},
            houses.map((h, i) => e('div', { key: h.id, className: `p-4 rounded-xl shadow-lg bg-white border text-center ${i===0 ? 'ring-2 ring-yellow-400' : ''}` },
                i===0 && e('div', {className: "text-yellow-500 mb-1 flex justify-center"}, e(Icons.Star, {className: "w-6 h-6"})),
                e('h3', {className: "font-bold text-xl", style: {color: chartData.find(d=>d.name===h.name)?.fill}}, h.name),
                e('div', {className: "text-4xl font-black text-gray-800"}, h.total_points?.toLocaleString() || "0")
            ))
        ),
        e('div', {className: "bg-white p-4 rounded-xl shadow h-80"},
            RC.ResponsiveContainer ? e(RC.ResponsiveContainer, { width: "100%", height: "100%" },
                e(RC.BarChart, { data: chartData },
                    e(RC.CartesianGrid, { strokeDasharray: "3 3" }),
                    e(RC.XAxis, { dataKey: "name" }),
                    e(RC.YAxis),
                    e(RC.Tooltip),
                    e(RC.Bar, { dataKey: "Points" },
                        chartData.map((entry, index) => e(RC.Cell, { key: `cell-${index}`, fill: entry.fill }))
                    )
                )
            ) : e('div', {className: "text-center pt-10 text-gray-500"}, "Charts failed to load.")
        )
    );
};

const Login = ({ db, appId, setIsStaff, setUserName, setIsAdmin, setActiveView }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [err, setErr] = useState('');
    const doLogin = async (ev) => {
        ev.preventDefault();
        try {
            const q = query(collection(db, `/artifacts/${appId}/public/data/users`), where("email", "==", email), where("password", "==", password));
            const snap = await getDocs(q);
            if (!snap.empty) {
                const uData = snap.docs[0].data();
                setIsStaff(true);
                setUserName(uData.name);
                setIsAdmin(uData.role === 'admin');
                setActiveView(uData.role === 'admin' ? 'admin' : 'entry');
            } else {
                setErr("Invalid credentials");
            }
        } catch (err) { setErr("Login error"); }
    };
    const signInWithGoogle = async () => {
        setErr('');
        try {
            const auth = getAuth();
            const provider = new GoogleAuthProvider();
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            const userEmail = user.email;
            const q = query(
                collection(db, `/artifacts/${appId}/public/data/users`),
                where('email', '==', userEmail)
            );
            const snap = await getDocs(q);
            if (!snap.empty) {
                const userData = snap.docs[0].data();
                setIsStaff(userData.role === 'staff' || userData.role === 'admin');
                setIsAdmin(userData.role === 'admin');
                setUserName(userData.name || user.displayName);
                setActiveView(userData.role === 'admin' ? 'admin' : 'entry');
            } else {
                setErr("User not authorized. Please contact admin.");
                await getAuth().signOut();
            }
        } catch (error) {
            setErr("Google sign-in failed: " + error.message);
        }
    };
    return e('div', {className: "flex justify-center items-center h-96"},
        e('form', {onSubmit: doLogin, className: "bg-white p-8 rounded-xl shadow-lg w-80 space-y-4"},
            e('h2', {className: "text-xl font-bold text-center"}, "Staff Login"),
            err && e('div', {className: "text-red-500 text-sm text-center"}, err),
            e('input', {className: "w-full border p-2 rounded", placeholder: "Email", value: email, onChange: ev=>setEmail(ev.target.value)}),
            e('input', {className: "w-full border p-2 rounded", type: "password", placeholder: "Password", value: password, onChange: ev=>setPassword(ev.target.value)}),
            e('button', {className: "w-full bg-indigo-600 text-white py-2 rounded"}, "Login"),
            e('div', {className: "relative my-4"}, 
                e('div', {className: "absolute inset-0 flex items-center"}, 
                    e('div', {className: "w-full border-t border-gray-300"})
                ),
                e('div', {className: "relative flex justify-center text-sm"}, 
                    e('span', {className: "px-2 bg-white text-gray-500"}, "Or")
                )
            ),
            e('button', {type: 'button', onClick: signInWithGoogle, className: 'w-full bg-white border border-gray-300 text-gray-700 py-2 rounded flex items-center justify-center space-x-2 hover:bg-gray-50'}, 
                e('img', {src: 'https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg', alt: 'Google', className: 'w-5 h-5'}),
                e('span', null, 'Sign in with Google')
            ),
            e('div', {className: "mt-4 text-xs text-gray-400 text-center"}, "Try: teacher@school.edu / password123")
        )
    );
};

// ...EntryView and AdminView definition go here --- paste from your original code...

const App = () => {
    // ...State setup
    const [db, setDb] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [userId, setUserId] = useState(null);
    const [permissionError, setPermissionError] = useState(false);
    const [isStaff, setIsStaff] = useState(false);
    const [isAdmin, setIsAdmin] = useState(false);
    const [activeView, setActiveView] = useState('leaderboard');
    const [userName, setUserName] = useState('');
    const [houses, setHouses] = useState([]);
    const [rubric, setRubric] = useState([]);
    const [allStudents, setAllStudents] = useState([]);
    const [transactions, setTransactions] = useState([]);
    const [usersList, setUsersList] = useState([]);
    // (End State setup)

    useEffect(() => {
        const app = initializeApp(firebaseConfig);
        const fAuth = getAuth(app);
        setDb(getFirestore(app));
        const initAuth = async () => {
            try {
                if (fAuth.currentUser) { await signOut(fAuth); }
                await signInAnonymously(fAuth);
            } catch(e) {}
        };
        initAuth();
        onAuthStateChanged(fAuth, (user) => {
            if (user) { setUserId(user.uid); setIsAuthReady(true); } else { setIsAuthReady(true); }
        });
    }, []);

    useEffect(() => {
        if (!db || !userId || permissionError) return;
        const basePath = `/artifacts/${appId}/public/data`;
        const handleError = (err) => {
            if (err.code === 'permission-denied') setPermissionError(true);
        };
        getDocs(collection(db, `${basePath}/houses`)).then(snap => {
            if(snap.empty) {
                const batch = writeBatch(db);
                const studentsRef = collection(db, `${basePath}/students`);
                [...INITIAL_USERS, ...HOUSE_SEED_DATA.map(h => ({...h, total_points: 0})), ...RUBRIC_SEED_DATA, ...CLASS_NAMES.map(n => ({class_name: n}))]
                    .forEach(item => {
                        let ref, docId;
                        if(item.email) { 
                            ref = collection(db, `${basePath}/users`); 
                            docId = item.email.replace(/[^a-zA-Z0-9]/g, '_'); 
                        } else if (item.name && item.motto) { 
                            ref = collection(db, `${basePath}/houses`); 
                            docId = item.name; 
                            item = {...item, total_points: 0};
                        } else if (item.class_name) { 
                            ref = collection(db, `${basePath}/classes`); 
                            docId = item.class_name; 
                        } else if (item.action) { 
                            ref = collection(db, `${basePath}/rubric`); 
                            docId = item.action.replace(/[^a-zA-Z0-9]/g, '_'); 
                        }
                        if (ref) batch.set(doc(ref, docId), item);
                    });
                FULL_STUDENT_DATA.forEach(s => {
                    const safeId = `${s.name.replace(/[^a-zA-Z0-9]/g, '')}_${s.class_name.replace(/[^a-zA-Z0-9]/g, '')}`;
                    batch.set(doc(studentsRef, safeId), { ...s, current_points: 0, id: safeId });
                });
                batch.commit();
            }
        }).catch(e => { if (e.code === 'permission-denied') setPermissionError(true); });
        const unsubH = onSnapshot(collection(db, `${basePath}/houses`), s => setHouses(s.docs.map(d => ({id:d.id,...d.data()}))), handleError);
        const unsubR = onSnapshot(collection(db, `${basePath}/rubric`), s => setRubric(s.docs.map(d => ({id:d.id,...d.data()}))), handleError);
        const unsubS = onSnapshot(collection(db, `${basePath}/students`), s => setAllStudents(s.docs.map(d => ({id:d.id,...d.data()}))), handleError);
        const unsubT = onSnapshot(query(collection(db, `${basePath}/transactions`), orderBy('timestamp', 'desc'), limit(50)), s => setTransactions(s.docs.map(d => ({id:d.id,...d.data()}))), handleError);
        let unsubU = () => {};
        if (isAdmin) { unsubU = onSnapshot(collection(db, `${basePath}/users`), s => setUsersList(s.docs.map(d => ({id:d.id,...d.data()}))), handleError); }
        return () => { unsubH(); unsubR(); unsubS(); unsubT(); unsubU(); };
    }, [db, userId, isAdmin, permissionError]);

    const handleLogout = () => { setIsStaff(false); setIsAdmin(false); setUserName(''); setActiveView('leaderboard'); };

    if (permissionError) {
        return e('div', {className: "flex items-center justify-center min-h-screen bg-red-50 p-4"},
            e('div', {className: "max-w-md bg-white p-8 rounded-xl shadow-lg border border-red-200 text-center"},
                e('div', {className: "text-red-500 mb-4 mx-auto w-12 h-12"}, e(Icons.Lock)),
                e('h2', {className: "text-2xl font-bold text-red-700 mb-2"}, "Permission Denied"),
                e('p', {className: "text-gray-600 mb-4"}, "Your Firebase Security Rules are blocking access."),
                e('p', {className: "font-bold text-sm text-gray-800 mt-4"}, "Action:"),
                e('ol', {className: "text-sm text-gray-700 list-decimal list-inside text-left mx-auto max-w-xs"}, 
                    e('li', null, "Go to Firebase Console > Firestore Database > Rules."),
                    e('li', null, "Publish the following rules (Test Mode) to unblock the app:")
                ),
                e('div', {className: "bg-gray-800 p-3 rounded text-white text-xs font-mono mb-4 mt-2 whitespace-pre-wrap text-left"}, "rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}")
            )
        );
    }
    if (!isAuthReady) return e('div', {className: "flex items-center justify-center h-screen text-gray-500"}, "Loading House System...");
    return (
        e('div', {className: "min-h-screen pb-10"},
            e('div', {className: "flex flex-col md:flex-row justify-between items-center p-4 bg-white border-b shadow-sm"},
                e('h1', {className: "text-2xl font-bold text-gray-800"}, "House Tracker"),
                e('div', {className: "flex gap-2 mt-2 md:mt-0"},
                    e('button', { onClick: () => setActiveView('entry'), className: `px-3 py-1 rounded text-sm font-semibold ${activeView === 'entry' ? 'bg-indigo-600 text-white' : 'bg-gray-100'}`}, "Entry"),
                    e('button', { onClick: () => setActiveView('leaderboard'), className: `px-3 py-1 rounded text-sm font-semibold ${activeView === 'leaderboard' ? 'bg-indigo-600 text-white' : 'bg-gray-100'}`}, "Leaderboard"),
                    isAdmin && e('button', { onClick: () => setActiveView('admin'), className: `px-3 py-1 rounded text-sm font-semibold ${activeView === 'admin' ? 'bg-indigo-600 text-white' : 'bg-gray-100'}`}, "Admin"),
                    isStaff && e('button', { onClick: handleLogout, className: "px-3 py-1 rounded text-sm font-semibold bg-red-100 text-red-600"}, "Logout")
                )
            ),
            activeView === 'leaderboard' && e(HouseLeaderboard, { houses: houses }),
            activeView === 'admin' && e('div', {className: "text-center mt-12"}, "AdminView here (paste code)"),
            activeView === 'entry' && (isStaff ? 
                e('div', {className: "text-center mt-12"}, "EntryView here (paste code)")
                : e(Login, { db, appId, setIsStaff, setUserName, setIsAdmin, setActiveView })
            )
        )
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(e(App, null));
</script>
</body>
</html>
